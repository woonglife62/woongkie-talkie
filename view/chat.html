<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <title>Woongkie-Talkie</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/view/style.css">
    <style>
        :focus-visible {
            outline: 3px solid #4a90d9;
            outline-offset: 2px;
        }
        .ws-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .ws-toast-error { background: #dc3545; color: #fff; }
        .ws-toast-warning { background: #ffc107; color: #333; }
        .ws-toast-info { background: #333; color: #fff; }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="/view/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/view/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/view/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/view/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/view/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/view/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/view/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/view/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/view/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/view/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/view/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/view/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/view/favicon/favicon-16x16.png">
    <link rel="manifest" href="/view/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/view/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
    <div id="app">
        <!-- 사이드바: 채팅방 목록 -->
        <nav id="sidebar" aria-label="채팅방 목록">
            <div id="sidebar-header">
                <h5>채팅방</h5>
                <button class="btn btn-sm btn-blue" id="create-room-btn" data-bs-toggle="modal"
                    data-bs-target="#createRoomModal" aria-label="새 채팅방 만들기">+</button>
            </div>
            <div id="room-list" role="list" aria-label="채팅방 목록"></div>
            <div id="sidebar-footer">
                <div id="profile-info" data-bs-toggle="modal" data-bs-target="#profileModal" title="프로필 편집"
                    role="button" tabindex="0" aria-label="프로필 편집">
                    <span id="profile-display-name-show"></span>
                    <span id="profile-bio-show"></span>
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="logout-btn" aria-label="로그아웃">로그아웃</button>
            </div>
        </nav>

        <div id="sidebar-backdrop" aria-hidden="true"></div>

        <!-- 메인 채팅 영역 -->
        <main id="main-chat">
            <header id="chat-header">
                <div id="room-info">
                    <button class="btn btn-sm" id="sidebar-toggle" style="display:none;" aria-label="사이드바 열기">&#9776;</button>
                    <span id="room-name" aria-live="polite">general</span>
                    <span id="room-desc">기본 채팅방</span>
                </div>
                <div id="chat-header-right">
                    <span id="conn-status" style="font-size:12px; margin-right:8px; color:#28a745;" aria-live="polite" aria-label="연결 상태">&#9679; 연결됨</span>
                    <span id="member-count" aria-label="접속 중인 참여자 수">0</span>
                    <button class="btn btn-sm btn-outline-secondary" id="toggle-members" aria-label="참여자 목록 보기">참여자</button>
                    <button id="theme-toggle" title="다크 모드 전환" aria-label="다크 모드 전환">&#9790;</button>
                </div>
            </header>

            <div id="chat-body">
                <div class="shadow-xll p-3 bg-body rounded" id="result"
                    role="log" aria-live="polite" aria-label="채팅 메시지"></div>

                <!-- 참여자 패널 -->
                <section id="members-panel" class="d-none" aria-label="참여자 목록">
                    <h6>참여자 목록</h6>
                    <div id="members-list"></div>
                </section>
            </div>

            <div id="typing-indicator" aria-live="polite" aria-atomic="true"></div>

            <div id="reply-preview" aria-live="polite">
                <span id="reply-preview-text"></span>
                <button id="reply-cancel" aria-label="답장 취소">&#10005;</button>
            </div>

            <div id="post-message">
                <div class="shadow-xl p-3 bg-body rounded">
                    <div class="input-group">
                        <input class="form-control" type="text" id="chat-message"
                            placeholder="메시지를 입력하세요. (Enter로 전송)"
                            aria-label="메시지 입력">
                        <button class="btn btn-blue" type="button" id="submit-btn" aria-label="메시지 전송">전송</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 채팅방 생성 모달 -->
    <div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createRoomModalTitle">채팅방 만들기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="new-room-name">채팅방 이름 *</label>
                        <input type="text" class="form-control" id="new-room-name" placeholder="채팅방 이름" aria-required="true">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="new-room-desc">설명</label>
                        <input type="text" class="form-control" id="new-room-desc" placeholder="채팅방 설명">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="new-room-public" checked>
                        <label class="form-check-label" for="new-room-public">공개 채팅방</label>
                    </div>
                    <div class="mb-3" id="password-field" style="display:none;">
                        <label class="form-label" for="new-room-password">비밀번호</label>
                        <input type="password" class="form-control" id="new-room-password" placeholder="비밀번호">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="new-room-max">최대 인원 (0 = 무제한)</label>
                        <input type="number" class="form-control" id="new-room-max" value="0" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-blue" id="confirm-create-room">만들기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 비밀번호 입력 모달 -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordModalTitle">비밀번호 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="join-room-password">비밀번호</label>
                    <input type="password" class="form-control" id="join-room-password" placeholder="비밀번호" aria-required="true" autocomplete="current-password">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-blue" id="confirm-join-password">참여</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 프로필 편집 모달 -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalTitle">프로필 편집</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="profile-display-name">표시 이름</label>
                        <input type="text" class="form-control" id="profile-display-name" maxlength="50" placeholder="표시 이름" autocomplete="nickname">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="profile-bio">소개</label>
                        <input type="text" class="form-control" id="profile-bio" maxlength="200" placeholder="한 줄 소개">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-blue" id="confirm-profile-save">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 메시지 편집 모달 -->
    <div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMessageModalTitle">메시지 편집</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="edit-message-input">메시지 내용</label>
                    <input type="text" class="form-control" id="edit-message-input" maxlength="2000" aria-label="메시지 내용 편집">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-blue" id="confirm-edit-message">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 쿠키 기반 인증: 서버가 httpOnly 쿠키로 JWT 관리
        // username은 /auth/me 에서 로드
        var currentUser = '';
        var ws = null;
        var currentRoomID = null;
        var currentRoomName = '';
        var pendingJoinRoomID = null;
        var reconnectDelay = 1000;
        var reconnectTimer = null;
        var isReconnecting = false;
        var reconnectAttempts = 0;
        var loading = false;
        var hasMore = true;
        var oldestTimestamp = null;
        var lastMessageTimestamp = null;

        // DOM 가상화: 화면에 유지할 최대 메시지 수
        var MAX_DOM_MESSAGES = 200;

        // 타이핑 인디케이터 상태
        var isTyping = false;
        var typingTimer = null;
        var typingUsers = {};

        // 모든 AJAX 요청에 credentials 포함 (쿠키 자동 전송)
        $.ajaxSetup({
            xhrFields: { withCredentials: true },
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        // authFetch: native fetch를 감싸 credentials 포함, 401 시 로그인 페이지로
        function authFetch(url, options) {
            options = options || {};
            options.credentials = 'include';
            options.headers = options.headers || {};
            options.headers['X-Requested-With'] = 'XMLHttpRequest';
            return fetch(url, options).then(function (response) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                return response;
            });
        }

        // $.ajax 401 처리: 로그인 페이지로
        $(document).ajaxError(function (event, jqXHR, ajaxSettings) {
            if (jqXHR.status === 401 && ajaxSettings.url !== '/auth/refresh') {
                window.location.href = '/login';
            }
        });

        // 초기화: /auth/me 로 인증 확인 및 사용자명 로드
        $(document).ready(function () {
            $.ajax({
                url: '/auth/me',
                method: 'GET',
                success: function (user) {
                    currentUser = user.username || '';
                    localStorage.setItem('username', currentUser);
                    $('#current-user-display').text(currentUser);
                    loadDefaultRoom();
                    loadRooms();
                    setInterval(loadRooms, 5000);
                },
                error: function () {
                    window.location.href = '/login';
                }
            });
        });

        // 로그아웃: 서버에 POST /auth/logout 호출하여 쿠키 삭제
        $('#logout-btn').on('click', function () {
            $.ajax({
                url: '/auth/logout',
                method: 'POST',
                complete: function () {
                    window.location.href = '/login';
                }
            });
        });

        // 기본 채팅방 로드
        function loadDefaultRoom() {
            $.ajax({
                url: '/rooms/default',
                method: 'GET',
                success: function (room) {
                    switchRoom(room.id, room.name, room.description);
                },
                error: function () {
                    console.error('기본 채팅방을 찾을 수 없습니다.');
                }
            });
        }

        // 채팅방 목록 로드
        function loadRooms() {
            $.ajax({
                url: '/rooms',
                method: 'GET',
                success: function (rooms) {
                    renderRoomList(rooms);
                }
            });
        }

        // 채팅방 목록 렌더링
        // #120: HTML이 변경된 경우에만 DOM 재구성 (불필요한 재렌더링 방지)
        function buildRoomListHTML(rooms) {
            var html = '';
            rooms.forEach(function (room) {
                var onlineCount = room.online_members ? room.online_members.length : 0;
                var activeClass = room.id === currentRoomID ? 'room-item active' : 'room-item';
                var defaultBadge = room.is_default ? ' <span class="badge bg-secondary">기본</span>' : '';
                html += '<div class="' + activeClass + '" data-room-id="' + room.id + '">' +
                    '<div class="room-item-name">' + escapeHtml(room.name) + defaultBadge + '</div>' +
                    '<div class="room-item-info">' +
                    '<span class="room-item-members">' + onlineCount + '명 접속</span>' +
                    '</div>' +
                    '</div>';
            });
            return html;
        }

        function renderRoomList(rooms) {
            var $list = $('#room-list');
            var newHTML = buildRoomListHTML(rooms);
            if ($list.html() === newHTML) return;
            $list.html(newHTML);
            // 클릭 이벤트 바인딩
            rooms.forEach(function (room) {
                $list.find('[data-room-id="' + room.id + '"]').on('click', function () {
                    var roomId = $(this).data('room-id');
                    if (roomId === currentRoomID) return;

                    // 비공개 방(비밀번호 있는 방)은 비밀번호 입력 필요
                    if (!room.is_public && room.has_password) {
                        pendingJoinRoomID = roomId;
                        var pwModal = new bootstrap.Modal(document.getElementById('passwordModal'));
                        pwModal.show();
                        return;
                    }

                    joinAndSwitch(roomId, room.name, room.description);
                });
            });
        }

        // 채팅방 참여 후 전환
        function joinAndSwitch(roomId, name, desc) {
            $.ajax({
                url: '/rooms/' + roomId + '/join',
                method: 'POST',
                contentType: 'application/json',
                success: function () {
                    switchRoom(roomId, name, desc);
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : '참여에 실패했습니다.');
                }
            });
        }

        // 채팅방 전환
        function switchRoom(roomId, name, desc) {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            reconnectDelay = 1000;
            isReconnecting = false;
            reconnectAttempts = 0;
            loading = false;
            hasMore = true;
            oldestTimestamp = null;
            lastMessageTimestamp = null;
            if (ws) {
                ws.close();
                ws = null;
            }
            currentRoomID = roomId;
            currentRoomName = name;

            $('#room-name').text(name);
            $('#room-desc').text(desc || '');
            $('#result').empty();

            // 방 목록에서 active 표시 갱신
            $('.room-item').removeClass('active');
            $('.room-item[data-room-id="' + roomId + '"]').addClass('active');

            connectWebSocket(roomId);
            loadMembers(roomId);
            loadInitialMessages(roomId);
        }

        // 방 입장 시 최근 메시지 REST로 로드하여 oldestTimestamp 초기화
        function loadInitialMessages(roomId) {
            $.ajax({
                url: '/rooms/' + roomId + '/messages',
                success: function(data) {
                    var messages = data.messages || [];
                    hasMore = data.has_more;

                    $('#result').empty();
                    for (var i = 0; i < messages.length; i++) {
                        var msg = messages[i];
                        appendMsg(msg.user, msg.message, msg.user === currentUser);
                    }

                    if (messages.length > 0) {
                        oldestTimestamp = messages[0].created_at;
                        lastMessageTimestamp = new Date().toISOString();
                    }
                }
            });
        }

        // 연결 상태 UI 업데이트
        function setConnStatus(state) {
            var $s = $('#conn-status');
            if (state === 'connected') {
                $s.css('color', '#28a745').html('&#9679; 연결됨');
            } else if (state === 'reconnecting') {
                $s.css('color', '#ffc107').html('&#9679; 재연결 중...');
            } else {
                $s.css('color', '#dc3545').html('&#9679; 끊김');
            }
        }

        // WebSocket 연결 (쿠키 기반 인증, 지수 백오프 재연결)
        function connectWebSocket(roomId) {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            var loc = window.location;
            var uri = (loc.protocol === 'https:') ? 'wss:' : 'ws:';
            uri += '//' + loc.host;
            uri += '/rooms/' + roomId + '/ws';

            ws = new WebSocket(uri);

            ws.onopen = function () {
                var wasReconnecting = reconnectAttempts > 0;
                reconnectDelay = 1000;
                isReconnecting = false;
                setConnStatus('connected');

                // 재연결 시 놓친 메시지 복구
                if (wasReconnecting && lastMessageTimestamp) {
                    $.ajax({
                        url: '/rooms/' + roomId + '/messages?after=' + encodeURIComponent(lastMessageTimestamp),
                        success: function(data) {
                            var messages = data.messages || [];
                            for (var i = 0; i < messages.length; i++) {
                                var msg = messages[i];
                                appendMsg(msg.user, msg.message, msg.user === currentUser);
                            }
                            if (messages.length > 0) {
                                lastMessageTimestamp = new Date().toISOString();
                            }
                        }
                    });
                }

                reconnectAttempts = 0;
                var sendData = { event: "OPEN" };
                ws.send(JSON.stringify(sendData));
            };

            ws.onmessage = function (event) {
                var recData;
                try {
                    recData = JSON.parse(event.data);
                } catch (e) {
                    console.error('WebSocket message parse error:', e);
                    return;
                }
                lastMessageTimestamp = new Date().toISOString();

                if (recData.Event === 'TYPING_START') {
                    // 3초 후 자동 제거 타이머 (서버가 TYPING_STOP을 보내지 않을 경우 대비)
                    if (typingUsers[recData.User]) {
                        clearTimeout(typingUsers[recData.User]);
                    }
                    typingUsers[recData.User] = setTimeout(function () {
                        delete typingUsers[recData.User];
                        updateTypingIndicator();
                    }, 5000);
                    updateTypingIndicator();
                    return;
                }

                if (recData.Event === 'TYPING_STOP') {
                    if (typingUsers[recData.User]) {
                        clearTimeout(typingUsers[recData.User]);
                        delete typingUsers[recData.User];
                    }
                    updateTypingIndicator();
                    return;
                }

                if (recData.Event === 'PRESENCE') {
                    // 접속/퇴장 시 참여자 목록 갱신
                    if (currentRoomID) {
                        loadMembers(currentRoomID);
                    }
                    return;
                }

                appendMessage(recData);
            };

            ws.onclose = function (event) {
                // 방이 전환된 경우(currentRoomID 변경) 재연결하지 않음
                if (currentRoomID !== roomId) {
                    return;
                }

                var code = event.code;
                console.log('WebSocket closed for room: ' + roomId + ', code: ' + code);

                if (code === 1000) {
                    // 정상 종료 - 재연결 안 함
                    setConnStatus('disconnected');
                    var $s = $('#conn-status');
                    $s.css('color', '#6c757d').html('&#9679; 연결 종료');
                    return;
                }

                if (code === 1001) {
                    // 서버 종료/페이지 이탈 - 재연결 시도
                    setConnStatus('reconnecting');
                    var $s = $('#conn-status');
                    $s.css('color', '#ffc107').html('&#9679; 서버 재시작 중...');
                    showToast('서버가 재시작 중입니다. 재연결을 시도합니다...', 'warning');
                    isReconnecting = true;
                    reconnectAttempts++;
                    reconnectTimer = setTimeout(function () {
                        if (currentRoomID === roomId) {
                            connectWebSocket(roomId);
                        }
                    }, reconnectDelay);
                    reconnectDelay = Math.min(reconnectDelay * 2, 30000);
                    return;
                }

                // 1006 (비정상) 또는 기타: 기존 재연결 로직
                setConnStatus('disconnected');
                setConnStatus('reconnecting');
                showToast('연결이 끊어졌습니다. 재연결을 시도합니다...', 'error');
                isReconnecting = true;
                reconnectAttempts++;
                reconnectTimer = setTimeout(function () {
                    if (currentRoomID === roomId) {
                        connectWebSocket(roomId);
                    }
                }, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, 30000);
            };

            ws.onerror = function (err) {
                console.log('WebSocket error for room: ' + roomId, err);
            };
        }

        // 메시지 표시
        function appendMessage(recData) {
            var outArea = document.getElementById('result');
            var newTagP = document.createElement('p');
            var newTagSpan = document.createElement('span');
            var isAlert = recData.Event === "OPEN" || recData.Event === "CLOSE";
            var isOwner = recData.owner === true;

            if (isAlert) {
                newTagP.setAttribute('class', 'p-alert');
                newTagSpan.setAttribute('class', 'span-alert');
            } else if (isOwner) {
                newTagP.setAttribute('class', 'p-me preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-me');
            } else {
                newTagP.setAttribute('class', 'p-you preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-you');

                var newTagSpanUser = document.createElement('span');
                newTagSpanUser.setAttribute('class', 'user-name');
                newTagSpanUser.innerText = recData.User;
                newTagP.appendChild(newTagSpanUser);

                var newTagSpanSpace = document.createElement('span');
                newTagSpanSpace.setAttribute('class', 'user-name-space');
                newTagSpanSpace.innerText = " ";
                newTagP.appendChild(newTagSpanSpace);
            }

            // 답장 인용 표시
            if (!isAlert && recData.reply_to) {
                var quoteSpan = document.createElement('span');
                quoteSpan.setAttribute('class', 'reply-quote');
                quoteSpan.textContent = '↩ 답장';
                newTagSpan.appendChild(quoteSpan);
            }

            // 메시지 텍스트 span (msg-text 클래스로 편집/삭제 시 참조)
            var msgTextSpan = document.createElement('span');
            msgTextSpan.setAttribute('class', 'msg-text');
            if (!isAlert && recData.message && validURL(recData.message)) {
                if (!validProtocol(recData.message)) {
                    msgTextSpan.innerHTML = '<a class="hypertext" href="https://' + escapeHtml(recData.message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(recData.message) + '</a>';
                } else {
                    msgTextSpan.innerHTML = '<a class="hypertext" href="' + escapeHtml(recData.message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(recData.message) + '</a>';
                }
            } else {
                msgTextSpan.textContent = recData.message;
            }
            newTagSpan.appendChild(msgTextSpan);
            newTagP.appendChild(newTagSpan);

            // data-msg-id 및 액션 버튼 추가 (일반 메시지만)
            if (!isAlert && recData.message_id) {
                newTagP.setAttribute('data-msg-id', recData.message_id);
                var actionsDiv = document.createElement('div');
                actionsDiv.setAttribute('class', 'msg-actions');
                actionsDiv.innerHTML = '<button class="msg-reply-btn">답장</button>';
                if (isOwner) {
                    actionsDiv.innerHTML += '<button class="msg-edit-btn">수정</button>' +
                                           '<button class="msg-delete-btn">삭제</button>';
                }
                newTagP.appendChild(actionsDiv);
            }

            outArea.appendChild(newTagP);
            trimOldMessages();

            // #123: 사용자가 하단 100px 이내에 있을 때만 자동 스크롤
            var $result = $("#result");
            var distFromBottom = $result[0].scrollHeight - $result[0].scrollTop - $result[0].clientHeight;
            if (distFromBottom <= 100) {
                $result.scrollTop($result[0].scrollHeight);
            }

            if (recData.Event === "MESSAGE") {
                beep();
            }
        }

        // 재연결 후 놓친 메시지 추가용 (owner 판별 포함)
        function appendMsg(user, message, isOwner) {
            var outArea = document.getElementById('result');
            var newTagP = document.createElement('p');
            var newTagSpan = document.createElement('span');

            if (isOwner) {
                newTagP.setAttribute('class', 'p-me preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-me');
            } else {
                newTagP.setAttribute('class', 'p-you preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-you');

                var newTagSpanUser = document.createElement('span');
                newTagSpanUser.setAttribute('class', 'user-name');
                newTagSpanUser.innerText = user || '';
                newTagP.appendChild(newTagSpanUser);

                var newTagSpanSpace = document.createElement('span');
                newTagSpanSpace.setAttribute('class', 'user-name-space');
                newTagSpanSpace.innerText = ' ';
                newTagP.appendChild(newTagSpanSpace);
            }

            if (message && validURL(message)) {
                if (!validProtocol(message)) {
                    newTagSpan.innerHTML = '<a class="hypertext" href="https://' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                } else {
                    newTagSpan.innerHTML = '<a class="hypertext" href="' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                }
            } else {
                newTagSpan.textContent = message || '';
            }

            newTagP.appendChild(newTagSpan);
            outArea.appendChild(newTagP);
            trimOldMessages();

            // #123: 사용자가 하단 100px 이내에 있을 때만 자동 스크롤
            var $result = $('#result');
            var distFromBottom = $result[0].scrollHeight - $result[0].scrollTop - $result[0].clientHeight;
            if (distFromBottom <= 100) {
                $result.scrollTop($result[0].scrollHeight);
            }
        }

        // 이전 메시지를 맨 위에 추가 (무한 스크롤)
        function prependChatMessage(chatMsg) {
            var outArea = document.getElementById('result');
            var newTagP = document.createElement('p');
            var newTagSpan = document.createElement('span');
            var user = chatMsg.user || '';
            var message = chatMsg.message || '';
            var isOwner = user === currentUser;

            if (isOwner) {
                newTagP.setAttribute('class', 'p-me preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-me');
            } else {
                newTagP.setAttribute('class', 'p-you preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-you');

                var newTagSpanUser = document.createElement('span');
                newTagSpanUser.setAttribute('class', 'user-name');
                newTagSpanUser.innerText = user;
                newTagP.appendChild(newTagSpanUser);

                var newTagSpanSpace = document.createElement('span');
                newTagSpanSpace.setAttribute('class', 'user-name-space');
                newTagSpanSpace.innerText = ' ';
                newTagP.appendChild(newTagSpanSpace);
            }

            if (message && validURL(message)) {
                if (!validProtocol(message)) {
                    newTagSpan.innerHTML = '<a class="hypertext" href="https://' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                } else {
                    newTagSpan.innerHTML = '<a class="hypertext" href="' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                }
            } else {
                newTagSpan.textContent = message;
            }

            newTagP.appendChild(newTagSpan);
            outArea.insertBefore(newTagP, outArea.firstChild);
            trimNewMessages();
        }

        // 이전 메시지 로딩 (무한 스크롤)
        function loadOlderMessages() {
            if (!oldestTimestamp || loading || !hasMore) return;
            loading = true;
            $('#result').prepend('<div id="load-spinner" class="text-center py-2"><small class="text-muted">이전 메시지 로딩 중...</small></div>');

            var scrollHeight = $('#result')[0].scrollHeight;

            $.ajax({
                url: '/rooms/' + currentRoomID + '/messages?before=' + encodeURIComponent(oldestTimestamp) + '&limit=50',
                success: function(data) {
                    $('#load-spinner').remove();
                    var messages = data.messages || [];
                    hasMore = data.has_more;

                    if (messages.length === 0) {
                        hasMore = false;
                        $('#result').prepend('<div class="text-center py-2"><small class="text-muted">대화의 시작입니다</small></div>');
                        loading = false;
                        return;
                    }

                    oldestTimestamp = messages[0].created_at;

                    // 역순으로 prepend (messages는 오래된 것부터 정렬)
                    for (var i = messages.length - 1; i >= 0; i--) {
                        var msg = messages[i];
                        prependChatMessage(msg);
                    }

                    // 스크롤 위치 보존
                    var newScrollHeight = $('#result')[0].scrollHeight;
                    $('#result')[0].scrollTop = newScrollHeight - scrollHeight;

                    loading = false;
                },
                error: function() {
                    $('#load-spinner').remove();
                    loading = false;
                }
            });
        }

        // 무한 스크롤: #result 최상단 도달 시 이전 메시지 로드
        $('#result').on('scroll', function() {
            if (this.scrollTop === 0 && !loading && hasMore) {
                loadOlderMessages();
            }
        });

        // 참여자 목록 로드
        function loadMembers(roomId) {
            $.ajax({
                url: '/rooms/' + roomId,
                method: 'GET',
                success: function (room) {
                    var online = room.online_members || [];
                    var members = room.members || [];
                    $('#member-count').text(online.length + '명');

                    var $list = $('#members-list');
                    $list.empty();
                    // 온라인 멤버 먼저
                    online.forEach(function (name) {
                        $list.append('<div class="member-item online">' + escapeHtml(name) + ' <span class="badge bg-success">접속중</span></div>');
                    });
                    // 오프라인 멤버
                    members.forEach(function (name) {
                        if (online.indexOf(name) === -1) {
                            $list.append('<div class="member-item">' + escapeHtml(name) + '</div>');
                        }
                    });
                }
            });
        }

        // 메시지 전송
        $("#chat-message").on("keyup", function (e) {
            if (e.keyCode == 13) {
                $("#submit-btn").click();
            }
        });

        $("#submit-btn").on("click", function () {
            var msg = $("#chat-message").val();
            if (msg == null || msg == "" || msg.trim() == "") return false;
            var sendData = { event: "MESSAGE", user: "", message: msg };
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(sendData));
            }
            // 전송 후 타이핑 상태 초기화
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: "TYPING_STOP" }));
                }
            }
            $("#chat-message").val("");
        });

        // 타이핑 인디케이터 전송
        $("#chat-message").on("input", function () {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!isTyping) {
                isTyping = true;
                ws.send(JSON.stringify({ event: "TYPING_START" }));
            }
            clearTimeout(typingTimer);
            typingTimer = setTimeout(function () {
                isTyping = false;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: "TYPING_STOP" }));
                }
            }, 3000);
        });

        // 타이핑 인디케이터 텍스트 업데이트
        function updateTypingIndicator() {
            var users = Object.keys(typingUsers);
            var $indicator = $('#typing-indicator');
            if (users.length === 0) {
                $indicator.text('');
            } else if (users.length === 1) {
                $indicator.text(escapeHtml(users[0]) + '님이 입력 중...');
            } else {
                $indicator.text(escapeHtml(users.join(', ')) + '님이 입력 중...');
            }
        }

        // 채팅방 생성
        $('#new-room-public').on('change', function () {
            if ($(this).is(':checked')) {
                $('#password-field').hide();
            } else {
                $('#password-field').show();
            }
        });

        $('#confirm-create-room').on('click', function () {
            var name = $('#new-room-name').val().trim();
            if (!name) {
                alert('채팅방 이름을 입력하세요.');
                return;
            }
            var data = {
                name: name,
                description: $('#new-room-desc').val().trim(),
                is_public: $('#new-room-public').is(':checked'),
                password: $('#new-room-password').val(),
                max_members: parseInt($('#new-room-max').val()) || 0
            };
            $.ajax({
                url: '/rooms',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (room) {
                    bootstrap.Modal.getInstance(document.getElementById('createRoomModal')).hide();
                    $('#new-room-name').val('');
                    $('#new-room-desc').val('');
                    $('#new-room-password').val('');
                    $('#new-room-max').val('0');
                    $('#new-room-public').prop('checked', true);
                    $('#password-field').hide();
                    loadRooms();
                    switchRoom(room.id, room.name, room.description);
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : '채팅방 생성에 실패했습니다.');
                }
            });
        });

        // 비밀번호 참여
        $('#confirm-join-password').on('click', function () {
            if (!pendingJoinRoomID) return;
            var pw = $('#join-room-password').val();
            $.ajax({
                url: '/rooms/' + pendingJoinRoomID + '/join',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ password: pw }),
                success: function () {
                    bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
                    $('#join-room-password').val('');
                    // Find room info and switch
                    $.ajax({
                        url: '/rooms/' + pendingJoinRoomID,
                        method: 'GET',
                        success: function (room) {
                            switchRoom(room.id, room.name, room.description);
                        }
                    });
                    pendingJoinRoomID = null;
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : '참여에 실패했습니다.');
                }
            });
        });

        // 참여자 패널 토글
        $('#toggle-members').on('click', function () {
            $('#members-panel').toggleClass('d-none');
            if (!$('#members-panel').hasClass('d-none') && currentRoomID) {
                loadMembers(currentRoomID);
            }
        });

        // DOM 가상화: 새 메시지 추가 후 위쪽(오래된) 노드 제거
        function trimOldMessages() {
            var outArea = document.getElementById('result');
            var children = outArea.children;
            while (children.length > MAX_DOM_MESSAGES) {
                outArea.removeChild(children[0]);
            }
        }

        // DOM 가상화: 이전 메시지 prepend 후 아래쪽(새) 노드 제거
        function trimNewMessages() {
            var outArea = document.getElementById('result');
            var children = outArea.children;
            while (children.length > MAX_DOM_MESSAGES) {
                outArea.removeChild(children[children.length - 1]);
            }
        }

        // 유틸리티 함수
        // #119: 전역 Audio 객체 재사용 (Audio leak 방지)
        var _beepAudio = new Audio("/view/sound/alert.mp3");
        function beep() {
            _beepAudio.currentTime = 0;
            _beepAudio.play();
        }

        function validURL(str) {
            var pattern = new RegExp('^(https?:\\/\\/)?' +
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' +
                '((\\d{1,3}\\.){3}\\d{1,3}))' +
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' +
                '(\\?[;&a-z\\d%_.~+=-]*)?' +
                '(\\#[-a-z\\d_]*)?$', 'i');
            return !!pattern.test(str);
        }

        function validProtocol(str) {
            // Only allow http and https; block javascript:, data:, etc.
            var pattern = /^https?:\/\//i;
            return !!pattern.test(str);
        }

        function safeHref(url) {
            // Double-check: only return URL if http/https
            if (/^https?:\/\//i.test(url)) return url;
            return 'https://' + url;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // WebSocket 연결 끊김 UI 알림
        function showToast(msg, type) {
            var toast = $('<div class="ws-toast ws-toast-' + (type || 'info') + '">' + escapeHtml(msg) + '</div>');
            $('body').append(toast);
            setTimeout(function () { toast.fadeOut(500, function () { toast.remove(); }); }, 5000);
        }

        // ── 프로필 ──────────────────────────────────────────────────────
        function loadProfile() {
            $.ajax({
                url: '/auth/me',
                method: 'GET',
                success: function (user) {
                    var name = user.display_name || user.username || currentUser;
                    var bio  = user.bio || '';
                    $('#profile-display-name-show').text(name);
                    $('#profile-bio-show').text(bio);
                    $('#profile-display-name').val(name);
                    $('#profile-bio').val(bio);
                }
            });
        }

        $('#confirm-profile-save').on('click', function () {
            var displayName = $('#profile-display-name').val().trim();
            var bio         = $('#profile-bio').val().trim();
            $.ajax({
                url: '/users/me/profile',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ display_name: displayName, bio: bio }),
                success: function (user) {
                    var name = user.display_name || user.username || currentUser;
                    $('#profile-display-name-show').text(name);
                    $('#profile-bio-show').text(user.bio || '');
                    bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : '프로필 저장에 실패했습니다.');
                }
            });
        });

        // ── 답장 ──────────────────────────────────────────────────────
        var replyToMsgID = null;

        function setReplyTo(msgId, msgText) {
            replyToMsgID = msgId;
            $('#reply-preview-text').text('답장: ' + msgText);
            $('#reply-preview').addClass('active');
            $('#chat-message').focus();
        }

        function clearReplyTo() {
            replyToMsgID = null;
            $('#reply-preview').removeClass('active');
            $('#reply-preview-text').text('');
        }

        $('#reply-cancel').on('click', function () {
            clearReplyTo();
        });

        // ── 메시지 전송 시 reply_to 포함 ────────────────────────────────
        // Override submit to handle reply via REST when replyToMsgID is set
        $('#submit-btn').off('click').on('click', function () {
            var msg = $('#chat-message').val();
            if (!msg || msg.trim() === '') return false;

            if (replyToMsgID) {
                // Send reply via REST
                $.ajax({
                    url: '/rooms/' + currentRoomID + '/messages/' + replyToMsgID + '/reply',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: msg }),
                    success: function () {
                        clearReplyTo();
                    },
                    error: function (xhr) {
                        var resp = xhr.responseJSON;
                        alert(resp ? resp.error : '답장 전송에 실패했습니다.');
                    }
                });
            } else {
                // Normal message via WebSocket
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: 'MESSAGE', user: '', message: msg }));
                }
            }

            // Stop typing indicator
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: 'TYPING_STOP' }));
                }
            }
            $('#chat-message').val('');
        });

        // 한글 IME 이중전송 방지
        var isComposing = false;
        document.getElementById('chat-message').addEventListener('compositionstart', function () {
            isComposing = true;
        });
        document.getElementById('chat-message').addEventListener('compositionend', function () {
            isComposing = false;
        });

        // Enter key for the overridden submit
        $('#chat-message').off('keyup').on('keyup', function (e) {
            if (e.keyCode === 13 && !isComposing) {
                $('#submit-btn').click();
            }
        });

        // ── 메시지 편집 ────────────────────────────────────────────────
        var editingMsgID = null;

        $(document).on('click', '.msg-edit-btn', function () {
            var $p = $(this).closest('p');
            editingMsgID = $p.data('msg-id');
            var currentText = $p.find('.msg-text').text();
            $('#edit-message-input').val(currentText);
            var modal = new bootstrap.Modal(document.getElementById('editMessageModal'));
            modal.show();
        });

        $('#confirm-edit-message').on('click', function () {
            if (!editingMsgID) return;
            var newMsg = $('#edit-message-input').val().trim();
            if (!newMsg) return;
            $.ajax({
                url: '/rooms/' + currentRoomID + '/messages/' + editingMsgID,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ message: newMsg }),
                success: function () {
                    bootstrap.Modal.getInstance(document.getElementById('editMessageModal')).hide();
                    editingMsgID = null;
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : '수정에 실패했습니다.');
                }
            });
        });

        // ── 메시지 삭제 ────────────────────────────────────────────────
        $(document).on('click', '.msg-delete-btn', function () {
            if (!confirm('메시지를 삭제하시겠습니까?')) return;
            var $p = $(this).closest('p');
            var msgId = $p.data('msg-id');
            $.ajax({
                url: '/rooms/' + currentRoomID + '/messages/' + msgId,
                method: 'DELETE',
                success: function () {},
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : '삭제에 실패했습니다.');
                }
            });
        });

        // ── 답장 버튼 ──────────────────────────────────────────────────
        $(document).on('click', '.msg-reply-btn', function () {
            var $p = $(this).closest('p');
            var msgId = $p.data('msg-id');
            var msgText = $p.find('.msg-text').text().substring(0, 50);
            setReplyTo(msgId, msgText);
        });

        // ── WS MSG_EDIT / MSG_DELETE 처리 ──────────────────────────────
        // Patch appendMessage to also handle MSG_EDIT and MSG_DELETE
        var _origAppendMessage = appendMessage;
        appendMessage = function (recData) {
            if (recData.Event === 'MSG_EDIT') {
                var $p = $('p[data-msg-id="' + recData.message_id + '"]');
                if ($p.length) {
                    $p.find('.msg-text').text(recData.message);
                }
                return;
            }
            if (recData.Event === 'MSG_DELETE') {
                var $p = $('p[data-msg-id="' + recData.message_id + '"]');
                if ($p.length) {
                    $p.find('.msg-text').text('(삭제된 메시지)').css('color', '#aaa');
                    $p.find('.msg-actions').remove();
                }
                return;
            }
            _origAppendMessage(recData);
        };

        // 프로필 초기 로드
        loadProfile();

        // 모바일 사이드바 토글
        function checkMobile() {
            if (window.innerWidth < 768) {
                $('#sidebar-toggle').show();
            } else {
                $('#sidebar-toggle').hide();
                $('#sidebar').removeClass('sidebar-open');
                $('#sidebar-backdrop').removeClass('active');
            }
        }

        function closeSidebar() {
            $('#sidebar').removeClass('sidebar-open');
            $('#sidebar-backdrop').removeClass('active');
        }

        $('#sidebar-toggle').on('click', function () {
            $('#sidebar').toggleClass('sidebar-open');
            $('#sidebar-backdrop').toggleClass('active');
        });

        $('#sidebar-backdrop').on('click', function () {
            closeSidebar();
        });

        // 방 선택 시 사이드바 닫기 (모바일)
        $(document).on('click', '.room-item', function () {
            if (window.innerWidth < 768) {
                closeSidebar();
            }
        });

        $(window).on('resize', function () {
            checkMobile();
        });

        // 터치 스와이프로 사이드바 열기/닫기
        (function () {
            var touchStartX = 0;
            var touchStartY = 0;

            document.addEventListener('touchstart', function (e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', function (e) {
                if (window.innerWidth >= 768) return;
                var dx = e.changedTouches[0].clientX - touchStartX;
                var dy = e.changedTouches[0].clientY - touchStartY;

                // 수평 스와이프가 수직보다 클 때만 처리
                if (Math.abs(dx) < Math.abs(dy)) return;

                if (dx > 60 && touchStartX < 40) {
                    // 왼쪽 가장자리에서 오른쪽으로 스와이프: 사이드바 열기
                    $('#sidebar').addClass('sidebar-open');
                    $('#sidebar-backdrop').addClass('active');
                } else if (dx < -60 && $('#sidebar').hasClass('sidebar-open')) {
                    // 왼쪽으로 스와이프: 사이드바 닫기
                    closeSidebar();
                }
            }, { passive: true });
        })();

        // 페이지 언로드 시 WebSocket 정상 종료 (code 1000)
        window.addEventListener('beforeunload', function () {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close(1000, 'page unload');
            }
        });

        // 초기 모바일 체크
        checkMobile();

        // ── 모바일 터치: 롱프레스 컨텍스트 메뉴 ───────────────────────
        (function () {
            var longPressTimer = null;
            var LONG_PRESS_MS = 500;
            var $ctxMenu = null;

            function showContextMenu(x, y, $p) {
                removeContextMenu();
                var msgId = $p.data('msg-id');
                if (!msgId) return;

                var isOwner = $p.hasClass('p-me');
                var msgText = $p.find('.msg-text').text().substring(0, 50);

                var items = '<div class="ctx-item ctx-reply">답장</div>';
                if (isOwner) {
                    items += '<div class="ctx-item ctx-edit">수정</div>';
                    items += '<div class="ctx-item ctx-delete">삭제</div>';
                }

                $ctxMenu = $('<div id="ctx-menu">' + items + '</div>');
                $ctxMenu.css({ top: y, left: x });
                $('body').append($ctxMenu);

                $ctxMenu.find('.ctx-reply').on('click', function () {
                    setReplyTo(msgId, msgText);
                    removeContextMenu();
                });
                $ctxMenu.find('.ctx-edit').on('click', function () {
                    var currentText = $p.find('.msg-text').text();
                    editingMsgID = msgId;
                    $('#edit-message-input').val(currentText);
                    new bootstrap.Modal(document.getElementById('editMessageModal')).show();
                    removeContextMenu();
                });
                $ctxMenu.find('.ctx-delete').on('click', function () {
                    removeContextMenu();
                    if (!confirm('메시지를 삭제하시겠습니까?')) return;
                    $.ajax({
                        url: '/rooms/' + currentRoomID + '/messages/' + msgId,
                        method: 'DELETE'
                    });
                });
            }

            function removeContextMenu() {
                if ($ctxMenu) { $ctxMenu.remove(); $ctxMenu = null; }
            }

            $(document).on('touchstart', 'p[data-msg-id]', function (e) {
                var $p = $(this);
                var touch = e.originalEvent.touches[0];
                longPressTimer = setTimeout(function () {
                    e.preventDefault();
                    showContextMenu(touch.clientX, touch.clientY, $p);
                }, LONG_PRESS_MS);
            });

            $(document).on('touchend touchmove touchcancel', 'p[data-msg-id]', function () {
                clearTimeout(longPressTimer);
            });

            $(document).on('click touchstart', function (e) {
                if ($ctxMenu && !$(e.target).closest('#ctx-menu').length) {
                    removeContextMenu();
                }
            });
        })();

        // ── 브라우저 알림 ──────────────────────────────────────────────
        (function () {
            var notifEnabled = localStorage.getItem('notif') !== 'off';

            function updateNotifBtn() {
                $('#notif-toggle').html(notifEnabled ? '&#128276;' : '&#128277;');
                $('#notif-toggle').attr('title', notifEnabled ? '알림 끄기' : '알림 켜기');
            }

            // 알림 버튼을 헤더에 주입
            if ('Notification' in window) {
                var $btn = $('<button id="notif-toggle" style="background:none;border:1px solid var(--color-border);color:var(--color-sidebar-text);border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;padding:0;" aria-label="알림 설정"></button>');
                $('#theme-toggle').after($btn);
                updateNotifBtn();

                $('#notif-toggle').on('click', function () {
                    if (!notifEnabled) {
                        Notification.requestPermission().then(function (perm) {
                            if (perm === 'granted') {
                                notifEnabled = true;
                                localStorage.setItem('notif', 'on');
                                updateNotifBtn();
                            }
                        });
                    } else {
                        notifEnabled = false;
                        localStorage.setItem('notif', 'off');
                        updateNotifBtn();
                    }
                });

                // 최초 방문 시 권한 요청
                if (notifEnabled && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            // 메시지 수신 시 알림 표시
            var _origBeep = beep;
            beep = function () {
                _origBeep();
                if (notifEnabled &&
                    'Notification' in window &&
                    Notification.permission === 'granted' &&
                    document.hidden) {
                    new Notification('Woongkie-Talkie', {
                        body: '새 메시지가 도착했습니다.',
                        icon: '/view/favicon/favicon-32x32.png'
                    });
                }
            };
        })();

        // ── 다크 모드 ──────────────────────────────────────────────────
        (function () {
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                $('#theme-toggle').html(theme === 'dark' ? '&#9728;' : '&#9790;');
                localStorage.setItem('theme', theme);
            }

            var saved = localStorage.getItem('theme');
            if (saved) {
                applyTheme(saved);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }

            $('#theme-toggle').on('click', function () {
                var current = document.documentElement.getAttribute('data-theme');
                applyTheme(current === 'dark' ? 'light' : 'dark');
            });

            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
                    if (!localStorage.getItem('theme')) {
                        applyTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        })();
    </script>
</body>

</html>
