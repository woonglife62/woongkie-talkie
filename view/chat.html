<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <title>Woongkie-Talkie</title>

    <!-- #127: ë‹¤í¬ ëª¨ë“œ FOUC ë°©ì§€ - CSS ë¡œë“œ ì „ì— í…Œë§ˆ í´ë˜ìŠ¤ë¥¼ ì¦‰ì‹œ ì ìš© -->
    <script>
        (function () {
            var saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/view/style.css">
    <style>
        :focus-visible {
            outline: 3px solid #4a90d9;
            outline-offset: 2px;
        }
        .ws-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .ws-toast-error { background: #dc3545; color: #fff; }
        .ws-toast-warning { background: #ffc107; color: #333; }
        .ws-toast-info { background: #333; color: #fff; }
        /* #131: ëª¨ë°”ì¼ ê°€ë¡œ íšŒì „ ì‹œ ë ˆì´ì•„ì›ƒ ì¡°ì • */
        @media (orientation: landscape) and (max-height: 500px) {
            #sidebar { max-height: 100vh; overflow-y: auto; }
            #chat-header { padding: 4px 8px; min-height: unset; }
            #post-message { padding: 4px 0; }
            #result { flex: 1; min-height: 0; }
            #typing-indicator { padding: 2px 8px; }
        }

        /* #86: ë©”ì‹œì§€ ê²€ìƒ‰ UI */
        #search-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            max-width: 280px;
            position: relative;
        }
        #search-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid var(--color-border, #ccc);
            border-radius: 16px;
            font-size: 13px;
            background: var(--color-bg, #fff);
            color: var(--color-text, #333);
            outline: none;
        }
        #search-input:focus {
            border-color: #4a90d9;
        }
        #search-clear-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #888;
            padding: 2px 4px;
            display: none;
        }
        #search-results-container {
            display: none;
            padding: 8px;
        }
        .search-result-item {
            padding: 6px 8px;
            border-bottom: 1px solid var(--color-border, #eee);
            font-size: 13px;
            cursor: default;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-highlight {
            background: #ffe082;
            border-radius: 2px;
            padding: 0 1px;
        }
        .search-no-result {
            text-align: center;
            color: #888;
            padding: 16px;
            font-size: 13px;
        }

        /* #86: ì˜¤í”„ë¼ì¸ ëŒ€ê¸° ë©”ì‹œì§€ */
        .msg-pending {
            opacity: 0.6;
            font-style: italic;
        }
        .msg-pending-label {
            font-size: 11px;
            color: #888;
            margin-left: 4px;
        }

        /* #88: ì´ëª¨ì§€ í”¼ì»¤ */
        #emoji-btn {
            background: none;
            border: 1px solid var(--color-border, #ccc);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
        }
        #emoji-btn:hover { background: var(--color-hover, #f0f0f0); }
        #emoji-picker {
            position: absolute;
            bottom: calc(100% + 8px);
            right: 0;
            background: var(--color-bg, #fff);
            border: 1px solid var(--color-border, #ccc);
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            width: 260px;
            display: none;
        }
        #emoji-picker.open { display: block; }
        .emoji-category-label {
            font-size: 11px;
            color: #888;
            margin: 4px 0 2px 2px;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }
        .emoji-grid button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 3px;
            border-radius: 4px;
            line-height: 1;
        }
        .emoji-grid button:hover {
            background: var(--color-hover, #f0f0f0);
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="/view/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/view/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/view/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/view/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/view/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/view/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/view/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/view/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/view/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/view/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/view/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/view/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/view/favicon/favicon-16x16.png">
    <link rel="manifest" href="/view/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/view/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
    <div id="app">
        <!-- ì‚¬ì´ë“œë°”: ì±„íŒ…ë°© ëª©ë¡ -->
        <nav id="sidebar" aria-label="ì±„íŒ…ë°© ëª©ë¡">
            <div id="sidebar-header">
                <h5>ì±„íŒ…ë°©</h5>
                <button class="btn btn-sm btn-blue" id="create-room-btn" data-bs-toggle="modal"
                    data-bs-target="#createRoomModal" aria-label="ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°">+</button>
            </div>
            <div id="room-list" role="tablist" aria-label="ì±„íŒ…ë°© ëª©ë¡" aria-orientation="vertical"></div>
            <div id="sidebar-footer">
                <div id="profile-info" data-bs-toggle="modal" data-bs-target="#profileModal" title="í”„ë¡œí•„ í¸ì§‘"
                    role="button" tabindex="0" aria-label="í”„ë¡œí•„ í¸ì§‘">
                    <span id="profile-display-name-show"></span>
                    <span id="profile-bio-show"></span>
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" id="logout-btn" aria-label="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>

        <div id="sidebar-backdrop" aria-hidden="true"></div>

        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <main id="main-chat">
            <header id="chat-header">
                <div id="room-info">
                    <button class="btn btn-sm" id="sidebar-toggle" style="display:none;" aria-label="ì‚¬ì´ë“œë°” ì—´ê¸°">&#9776;</button>
                    <span id="room-name" aria-live="polite">general</span>
                    <span id="room-desc">ê¸°ë³¸ ì±„íŒ…ë°©</span>
                </div>
                <!-- #86: ë©”ì‹œì§€ ê²€ìƒ‰ ë°” -->
                <div id="search-bar" role="search" aria-label="ë©”ì‹œì§€ ê²€ìƒ‰">
                    <input type="text" id="search-input" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰..." aria-label="ë©”ì‹œì§€ ê²€ìƒ‰" autocomplete="off">
                    <button id="search-clear-btn" type="button" aria-label="ê²€ìƒ‰ ì´ˆê¸°í™”" title="ê²€ìƒ‰ ì´ˆê¸°í™”">&#10005;</button>
                </div>
                <div id="chat-header-right">
                    <span id="conn-status" style="font-size:12px; margin-right:8px; color:#28a745;" aria-live="polite" aria-label="ì—°ê²° ìƒíƒœ">&#9679; ì—°ê²°ë¨</span>
                    <span id="member-count" aria-label="ì ‘ì† ì¤‘ì¸ ì°¸ì—¬ì ìˆ˜">0</span>
                    <button class="btn btn-sm btn-outline-secondary" id="toggle-members" aria-label="ì°¸ì—¬ì ëª©ë¡ ë³´ê¸°">ì°¸ì—¬ì</button>
                    <button id="theme-toggle" title="ë‹¤í¬ ëª¨ë“œ ì „í™˜" aria-label="ë‹¤í¬ ëª¨ë“œ ì „í™˜">&#9790;</button>
                </div>
            </header>

            <!-- #86: ê²€ìƒ‰ ê²°ê³¼ ì»¨í…Œì´ë„ˆ -->
            <div id="search-results-container" aria-live="polite" aria-label="ê²€ìƒ‰ ê²°ê³¼"></div>

            <div id="chat-body">
                <div class="shadow-xll p-3 bg-body rounded" id="result"
                    role="log" aria-live="polite" aria-label="ì±„íŒ… ë©”ì‹œì§€"></div>

                <!-- ì°¸ì—¬ì íŒ¨ë„ -->
                <section id="members-panel" class="d-none" aria-label="ì°¸ì—¬ì ëª©ë¡">
                    <h6>ì°¸ì—¬ì ëª©ë¡</h6>
                    <div id="members-list"></div>
                </section>
            </div>

            <div id="typing-indicator" aria-live="polite" aria-atomic="true"></div>

            <div id="reply-preview" aria-live="polite">
                <span id="reply-preview-text"></span>
                <button id="reply-cancel" aria-label="ë‹µì¥ ì·¨ì†Œ">&#10005;</button>
            </div>

            <div id="post-message">
                <div class="shadow-xl p-3 bg-body rounded">
                    <div class="input-group" style="position:relative;">
                        <input class="form-control" type="text" id="chat-message"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (Enterë¡œ ì „ì†¡)"
                            aria-label="ë©”ì‹œì§€ ì…ë ¥">
                        <!-- #88: ì´ëª¨ì§€ í”¼ì»¤ ë²„íŠ¼ -->
                        <button id="emoji-btn" type="button" title="ì´ëª¨ì§€" aria-label="ì´ëª¨ì§€ ì„ íƒ">ğŸ˜€</button>
                        <!-- #88: ì´ëª¨ì§€ í”¼ì»¤ íŒì—… -->
                        <div id="emoji-picker" role="dialog" aria-label="ì´ëª¨ì§€ ì„ íƒ">
                            <div class="emoji-category-label">ìì£¼</div>
                            <div class="emoji-grid">
                                <button type="button">ğŸ˜€</button><button type="button">ğŸ˜‚</button><button type="button">â¤ï¸</button><button type="button">ğŸ‘</button><button type="button">ğŸ‰</button><button type="button">ğŸ”¥</button><button type="button">ğŸ’¯</button><button type="button">ğŸ˜Š</button><button type="button">ğŸ¥º</button><button type="button">ğŸ˜­</button>
                            </div>
                            <div class="emoji-category-label">ê°ì •</div>
                            <div class="emoji-grid">
                                <button type="button">ğŸ˜</button><button type="button">ğŸ¥°</button><button type="button">ğŸ˜˜</button><button type="button">ğŸ˜œ</button><button type="button">ğŸ¤”</button><button type="button">ğŸ˜¤</button><button type="button">ğŸ˜±</button><button type="button">ğŸ¤—</button><button type="button">ğŸ˜´</button><button type="button">ğŸ˜</button>
                            </div>
                            <div class="emoji-category-label">ì†</div>
                            <div class="emoji-grid">
                                <button type="button">ğŸ‘‹</button><button type="button">âœŒï¸</button><button type="button">ğŸ¤</button><button type="button">ğŸ™</button><button type="button">ğŸ’ª</button><button type="button">ğŸ‘</button><button type="button">ğŸ¤</button><button type="button">ğŸ‘Š</button><button type="button">ğŸ¤™</button><button type="button">âœ‹</button>
                            </div>
                            <div class="emoji-category-label">ê¸°íƒ€</div>
                            <div class="emoji-grid">
                                <button type="button">â­</button><button type="button">ğŸŒˆ</button><button type="button">â˜€ï¸</button><button type="button">ğŸµ</button><button type="button">ğŸ’¬</button><button type="button">âœ…</button><button type="button">âŒ</button><button type="button">ğŸ </button><button type="button">ğŸ“±</button><button type="button">ğŸ’»</button>
                            </div>
                        </div>
                        <button class="btn btn-blue" type="button" id="submit-btn" aria-label="ë©”ì‹œì§€ ì „ì†¡">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
    <div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createRoomModalTitle">ì±„íŒ…ë°© ë§Œë“¤ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="new-room-name">ì±„íŒ…ë°© ì´ë¦„ *</label>
                        <input type="text" class="form-control" id="new-room-name" placeholder="ì±„íŒ…ë°© ì´ë¦„" aria-required="true">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="new-room-desc">ì„¤ëª…</label>
                        <input type="text" class="form-control" id="new-room-desc" placeholder="ì±„íŒ…ë°© ì„¤ëª…">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="new-room-public" checked>
                        <label class="form-check-label" for="new-room-public">ê³µê°œ ì±„íŒ…ë°©</label>
                    </div>
                    <div class="mb-3" id="password-field" style="display:none;">
                        <label class="form-label" for="new-room-password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="new-room-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="new-room-max">ìµœëŒ€ ì¸ì› (0 = ë¬´ì œí•œ)</label>
                        <input type="number" class="form-control" id="new-room-max" value="0" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-blue" id="confirm-create-room">ë§Œë“¤ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordModalTitle">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="join-room-password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="form-control" id="join-room-password" placeholder="ë¹„ë°€ë²ˆí˜¸" aria-required="true" autocomplete="current-password">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-blue" id="confirm-join-password">ì°¸ì—¬</button>
                </div>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalTitle">í”„ë¡œí•„ í¸ì§‘</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="profile-display-name">í‘œì‹œ ì´ë¦„</label>
                        <input type="text" class="form-control" id="profile-display-name" maxlength="50" placeholder="í‘œì‹œ ì´ë¦„" autocomplete="nickname">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="profile-bio">ì†Œê°œ</label>
                        <input type="text" class="form-control" id="profile-bio" maxlength="200" placeholder="í•œ ì¤„ ì†Œê°œ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-blue" id="confirm-profile-save">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ í¸ì§‘ ëª¨ë‹¬ -->
    <div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageModalTitle" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMessageModalTitle">ë©”ì‹œì§€ í¸ì§‘</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="edit-message-input">ë©”ì‹œì§€ ë‚´ìš©</label>
                    <input type="text" class="form-control" id="edit-message-input" maxlength="2000" aria-label="ë©”ì‹œì§€ ë‚´ìš© í¸ì§‘">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-blue" id="confirm-edit-message">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦: ì„œë²„ê°€ httpOnly ì¿ í‚¤ë¡œ JWT ê´€ë¦¬
        // usernameì€ /auth/me ì—ì„œ ë¡œë“œ
        var currentUser = '';
        var ws = null;
        var currentRoomID = null;
        var currentRoomName = '';
        var pendingJoinRoomID = null;
        var reconnectDelay = 1000;
        var reconnectTimer = null;
        var isReconnecting = false;
        var reconnectAttempts = 0;
        var loading = false;
        var hasMore = true;
        var oldestTimestamp = null;
        var lastMessageTimestamp = null;

        // DOM ê°€ìƒí™”: í™”ë©´ì— ìœ ì§€í•  ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜
        var MAX_DOM_MESSAGES = 200;

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìƒíƒœ
        var isTyping = false;
        var typingTimer = null;
        var typingUsers = {};

        // ëª¨ë“  AJAX ìš”ì²­ì— credentials í¬í•¨ (ì¿ í‚¤ ìë™ ì „ì†¡)
        $.ajaxSetup({
            xhrFields: { withCredentials: true },
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        // authFetch: native fetchë¥¼ ê°ì‹¸ credentials í¬í•¨, 401 ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        function authFetch(url, options) {
            options = options || {};
            options.credentials = 'include';
            options.headers = options.headers || {};
            options.headers['X-Requested-With'] = 'XMLHttpRequest';
            return fetch(url, options).then(function (response) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    showToast('ìš”ì²­ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (HTTP ' + response.status + ')', 'error');
                }
                return response;
            }).catch(function (err) {
                console.error('fetch error:', err);
                showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                throw err;
            });
        }

        // $.ajax 401 ì²˜ë¦¬: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        $(document).ajaxError(function (event, jqXHR, ajaxSettings) {
            if (jqXHR.status === 401 && ajaxSettings.url !== '/auth/refresh') {
                window.location.href = '/login';
            }
        });

        // ì´ˆê¸°í™”: /auth/me ë¡œ ì¸ì¦ í™•ì¸ ë° ì‚¬ìš©ìëª… ë¡œë“œ
        $(document).ready(function () {
            $.ajax({
                url: '/auth/me',
                method: 'GET',
                success: function (user) {
                    currentUser = user.username || '';
                    localStorage.setItem('username', currentUser);
                    $('#current-user-display').text(currentUser);
                    loadDefaultRoom();
                    loadRooms();
                    // #81: íƒ­ ë¹„í™œì„± ì‹œ ë¶ˆí•„ìš”í•œ í´ë§ ì¤‘ë‹¨
                    var roomListInterval = setInterval(loadRooms, 5000);
                    document.addEventListener('visibilitychange', function () {
                        if (document.hidden) {
                            clearInterval(roomListInterval);
                            roomListInterval = null;
                        } else {
                            loadRooms();
                            if (!roomListInterval) {
                                roomListInterval = setInterval(loadRooms, 5000);
                            }
                        }
                    });
                },
                error: function () {
                    window.location.href = '/login';
                }
            });
        });

        // ë¡œê·¸ì•„ì›ƒ: ì„œë²„ì— POST /auth/logout í˜¸ì¶œí•˜ì—¬ ì¿ í‚¤ ì‚­ì œ
        $('#logout-btn').on('click', function () {
            $.ajax({
                url: '/auth/logout',
                method: 'POST',
                complete: function () {
                    window.location.href = '/login';
                }
            });
        });

        // ê¸°ë³¸ ì±„íŒ…ë°© ë¡œë“œ
        function loadDefaultRoom() {
            $.ajax({
                url: '/rooms/default',
                method: 'GET',
                success: function (room) {
                    switchRoom(room.id, room.name, room.description);
                },
                error: function () {
                    console.error('ê¸°ë³¸ ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
        function loadRooms() {
            $.ajax({
                url: '/rooms',
                method: 'GET',
                success: function (rooms) {
                    renderRoomList(rooms);
                }
            });
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
        // #120: HTMLì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ DOM ì¬êµ¬ì„± (ë¶ˆí•„ìš”í•œ ì¬ë Œë”ë§ ë°©ì§€)
        function buildRoomListHTML(rooms) {
            var html = '';
            rooms.forEach(function (room, index) {
                var onlineCount = room.online_members ? room.online_members.length : 0;
                var isActive = room.id === currentRoomID;
                var activeClass = isActive ? 'room-item active' : 'room-item';
                var defaultBadge = room.is_default ? ' <span class="badge bg-secondary">ê¸°ë³¸</span>' : '';
                // #124: ARIA tab role + keyboard navigation support
                var tabIndex = isActive ? '0' : '-1';
                var ariaSelected = isActive ? 'true' : 'false';
                html += '<div class="' + activeClass + '" data-room-id="' + room.id + '"' +
                    ' role="tab" tabindex="' + tabIndex + '" aria-selected="' + ariaSelected + '"' +
                    ' id="room-tab-' + room.id + '">' +
                    '<div class="room-item-name">' + escapeHtml(room.name) + defaultBadge + '</div>' +
                    '<div class="room-item-info">' +
                    '<span class="room-item-members">' + onlineCount + 'ëª… ì ‘ì†</span>' +
                    '</div>' +
                    '</div>';
            });
            return html;
        }

        function renderRoomList(rooms) {
            var $list = $('#room-list');
            var newHTML = buildRoomListHTML(rooms);
            if ($list.html() === newHTML) return;
            $list.html(newHTML);
            // í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            rooms.forEach(function (room) {
                $list.find('[data-room-id="' + room.id + '"]').on('click', function () {
                    var roomId = $(this).data('room-id');
                    if (roomId === currentRoomID) return;

                    // ë¹„ê³µê°œ ë°©(ë¹„ë°€ë²ˆí˜¸ ìˆëŠ” ë°©)ì€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìš”
                    if (!room.is_public && room.has_password) {
                        pendingJoinRoomID = roomId;
                        var pwModal = new bootstrap.Modal(document.getElementById('passwordModal'));
                        pwModal.show();
                        return;
                    }

                    joinAndSwitch(roomId, room.name, room.description);
                });
            });

            // #124: í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ (ArrowUp/ArrowDown, Enter/Space)
            $list.off('keydown.roomtab').on('keydown.roomtab', '[role="tab"]', function (e) {
                var $tabs = $list.find('[role="tab"]');
                var $current = $(this);
                var idx = $tabs.index($current);
                var $target = null;
                if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                    $target = $tabs.eq((idx + 1) % $tabs.length);
                } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                    $target = $tabs.eq((idx - 1 + $tabs.length) % $tabs.length);
                } else if (e.key === 'Enter' || e.key === ' ') {
                    $current.trigger('click');
                    e.preventDefault();
                    return;
                } else {
                    return;
                }
                e.preventDefault();
                $tabs.attr('tabindex', '-1');
                $target.attr('tabindex', '0').focus();
            });
        }

        // ì±„íŒ…ë°© ì°¸ì—¬ í›„ ì „í™˜
        function joinAndSwitch(roomId, name, desc) {
            $.ajax({
                url: '/rooms/' + roomId + '/join',
                method: 'POST',
                contentType: 'application/json',
                success: function () {
                    switchRoom(roomId, name, desc);
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : 'ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ì±„íŒ…ë°© ì „í™˜
        function switchRoom(roomId, name, desc) {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            reconnectDelay = 1000;
            isReconnecting = false;
            reconnectAttempts = 0;
            loading = false;
            hasMore = true;
            oldestTimestamp = null;
            lastMessageTimestamp = null;
            if (ws) {
                ws.close();
                ws = null;
            }
            currentRoomID = roomId;
            currentRoomName = name;

            $('#room-name').text(name);
            $('#room-desc').text(desc || '');
            $('#result').empty();

            // ë°© ëª©ë¡ì—ì„œ active í‘œì‹œ ê°±ì‹ 
            $('.room-item').removeClass('active');
            $('.room-item[data-room-id="' + roomId + '"]').addClass('active');

            connectWebSocket(roomId);
            loadMembers(roomId);
            loadInitialMessages(roomId);
        }

        // ë°© ì…ì¥ ì‹œ ìµœê·¼ ë©”ì‹œì§€ RESTë¡œ ë¡œë“œí•˜ì—¬ oldestTimestamp ì´ˆê¸°í™”
        function loadInitialMessages(roomId) {
            $.ajax({
                url: '/rooms/' + roomId + '/messages',
                success: function(data) {
                    var messages = data.messages || [];
                    hasMore = data.has_more;

                    $('#result').empty();
                    for (var i = 0; i < messages.length; i++) {
                        var msg = messages[i];
                        appendMsg(msg.user, msg.message, msg.user === currentUser, msg.id);
                    }

                    if (messages.length > 0) {
                        oldestTimestamp = messages[0].created_at;
                        lastMessageTimestamp = new Date().toISOString();
                    }
                },
                error: function() {
                    showToast('ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
        }

        // ì—°ê²° ìƒíƒœ UI ì—…ë°ì´íŠ¸
        function setConnStatus(state) {
            var $s = $('#conn-status');
            if (state === 'connected') {
                $s.css('color', '#28a745').html('&#9679; ì—°ê²°ë¨');
            } else if (state === 'reconnecting') {
                $s.css('color', '#ffc107').html('&#9679; ì¬ì—°ê²° ì¤‘...');
            } else {
                $s.css('color', '#dc3545').html('&#9679; ëŠê¹€');
            }
        }

        // WebSocket ì—°ê²° (ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦, ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì—°ê²°)
        function connectWebSocket(roomId) {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            var loc = window.location;
            var uri = (loc.protocol === 'https:') ? 'wss:' : 'ws:';
            uri += '//' + loc.host;
            uri += '/rooms/' + roomId + '/ws';

            ws = new WebSocket(uri);

            ws.onopen = function () {
                var wasReconnecting = reconnectAttempts > 0;
                reconnectDelay = 1000;
                isReconnecting = false;
                setConnStatus('connected');

                // ì¬ì—°ê²° ì‹œ ë†“ì¹œ ë©”ì‹œì§€ ë³µêµ¬
                if (wasReconnecting && lastMessageTimestamp) {
                    $.ajax({
                        url: '/rooms/' + roomId + '/messages?after=' + encodeURIComponent(lastMessageTimestamp),
                        success: function(data) {
                            var messages = data.messages || [];
                            for (var i = 0; i < messages.length; i++) {
                                var msg = messages[i];
                                appendMsg(msg.user, msg.message, msg.user === currentUser, msg.id);
                            }
                            if (messages.length > 0) {
                                lastMessageTimestamp = new Date().toISOString();
                            }
                        },
                        error: function() {
                            showToast('ë†“ì¹œ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    });
                }

                reconnectAttempts = 0;
                var sendData = { event: "OPEN" };
                ws.send(JSON.stringify(sendData));
            };

            ws.onmessage = function (event) {
                var recData;
                try {
                    recData = JSON.parse(event.data);
                } catch (e) {
                    console.error('WebSocket message parse error:', e);
                    return;
                }
                lastMessageTimestamp = new Date().toISOString();

                if (recData.Event === 'TYPING_START') {
                    // 3ì´ˆ í›„ ìë™ ì œê±° íƒ€ì´ë¨¸ (ì„œë²„ê°€ TYPING_STOPì„ ë³´ë‚´ì§€ ì•Šì„ ê²½ìš° ëŒ€ë¹„)
                    if (typingUsers[recData.User]) {
                        clearTimeout(typingUsers[recData.User]);
                    }
                    typingUsers[recData.User] = setTimeout(function () {
                        delete typingUsers[recData.User];
                        updateTypingIndicator();
                    }, 5000);
                    updateTypingIndicator();
                    return;
                }

                if (recData.Event === 'TYPING_STOP') {
                    if (typingUsers[recData.User]) {
                        clearTimeout(typingUsers[recData.User]);
                        delete typingUsers[recData.User];
                    }
                    updateTypingIndicator();
                    return;
                }

                if (recData.Event === 'PRESENCE') {
                    // ì ‘ì†/í‡´ì¥ ì‹œ ì°¸ì—¬ì ëª©ë¡ ê°±ì‹ 
                    if (currentRoomID) {
                        loadMembers(currentRoomID);
                    }
                    return;
                }

                appendMessage(recData);
            };

            ws.onclose = function (event) {
                // ë°©ì´ ì „í™˜ëœ ê²½ìš°(currentRoomID ë³€ê²½) ì¬ì—°ê²°í•˜ì§€ ì•ŠìŒ
                if (currentRoomID !== roomId) {
                    return;
                }

                var code = event.code;
                console.log('WebSocket closed for room: ' + roomId + ', code: ' + code);

                if (code === 1000) {
                    // ì •ìƒ ì¢…ë£Œ - ì¬ì—°ê²° ì•ˆ í•¨
                    setConnStatus('disconnected');
                    var $s = $('#conn-status');
                    $s.css('color', '#6c757d').html('&#9679; ì—°ê²° ì¢…ë£Œ');
                    return;
                }

                if (code === 1001) {
                    // ì„œë²„ ì¢…ë£Œ/í˜ì´ì§€ ì´íƒˆ - ì¬ì—°ê²° ì‹œë„
                    setConnStatus('reconnecting');
                    var $s = $('#conn-status');
                    $s.css('color', '#ffc107').html('&#9679; ì„œë²„ ì¬ì‹œì‘ ì¤‘...');
                    showToast('ì„œë²„ê°€ ì¬ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...', 'warning');
                    isReconnecting = true;
                    reconnectAttempts++;
                    reconnectTimer = setTimeout(function () {
                        if (currentRoomID === roomId) {
                            connectWebSocket(roomId);
                        }
                    }, reconnectDelay);
                    reconnectDelay = Math.min(reconnectDelay * 2, 30000);
                    return;
                }

                // 1006 (ë¹„ì •ìƒ) ë˜ëŠ” ê¸°íƒ€: ê¸°ì¡´ ì¬ì—°ê²° ë¡œì§
                setConnStatus('disconnected');
                setConnStatus('reconnecting');
                showToast('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...', 'error');
                isReconnecting = true;
                reconnectAttempts++;
                reconnectTimer = setTimeout(function () {
                    if (currentRoomID === roomId) {
                        connectWebSocket(roomId);
                    }
                }, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, 30000);
            };

            ws.onerror = function (err) {
                console.log('WebSocket error for room: ' + roomId, err);
            };
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function appendMessage(recData) {
            var outArea = document.getElementById('result');
            var newTagP = document.createElement('p');
            var newTagSpan = document.createElement('span');
            var isAlert = recData.Event === "OPEN" || recData.Event === "CLOSE";
            var isOwner = recData.owner === true;

            if (isAlert) {
                newTagP.setAttribute('class', 'p-alert');
                newTagSpan.setAttribute('class', 'span-alert');
            } else if (isOwner) {
                newTagP.setAttribute('class', 'p-me preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-me');
            } else {
                newTagP.setAttribute('class', 'p-you preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-you');

                var newTagSpanUser = document.createElement('span');
                newTagSpanUser.setAttribute('class', 'user-name');
                newTagSpanUser.innerText = recData.User;
                newTagP.appendChild(newTagSpanUser);

                var newTagSpanSpace = document.createElement('span');
                newTagSpanSpace.setAttribute('class', 'user-name-space');
                newTagSpanSpace.innerText = " ";
                newTagP.appendChild(newTagSpanSpace);
            }

            // ë‹µì¥ ì¸ìš© í‘œì‹œ
            if (!isAlert && recData.reply_to) {
                var quoteSpan = document.createElement('span');
                quoteSpan.setAttribute('class', 'reply-quote');
                quoteSpan.textContent = 'â†© ë‹µì¥';
                newTagSpan.appendChild(quoteSpan);
            }

            // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ span (msg-text í´ë˜ìŠ¤ë¡œ í¸ì§‘/ì‚­ì œ ì‹œ ì°¸ì¡°)
            var msgTextSpan = document.createElement('span');
            msgTextSpan.setAttribute('class', 'msg-text');
            if (!isAlert && recData.message && validURL(recData.message)) {
                if (!validProtocol(recData.message)) {
                    msgTextSpan.innerHTML = '<a class="hypertext" href="https://' + escapeHtml(recData.message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(recData.message) + '</a>';
                } else {
                    msgTextSpan.innerHTML = '<a class="hypertext" href="' + escapeHtml(recData.message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(recData.message) + '</a>';
                }
            } else {
                msgTextSpan.textContent = recData.message;
            }
            newTagSpan.appendChild(msgTextSpan);
            newTagP.appendChild(newTagSpan);

            // data-msg-id ë° ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€ (ì¼ë°˜ ë©”ì‹œì§€ë§Œ)
            if (!isAlert && recData.message_id) {
                newTagP.setAttribute('data-msg-id', recData.message_id);
                var actionsDiv = document.createElement('div');
                actionsDiv.setAttribute('class', 'msg-actions');
                actionsDiv.innerHTML = '<button class="msg-reply-btn">ë‹µì¥</button>';
                if (isOwner) {
                    actionsDiv.innerHTML += '<button class="msg-edit-btn">ìˆ˜ì •</button>' +
                                           '<button class="msg-delete-btn">ì‚­ì œ</button>';
                }
                newTagP.appendChild(actionsDiv);
            }

            outArea.appendChild(newTagP);
            trimOldMessages();

            // #123: ì‚¬ìš©ìê°€ í•˜ë‹¨ 100px ì´ë‚´ì— ìˆì„ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤
            var $result = $("#result");
            var distFromBottom = $result[0].scrollHeight - $result[0].scrollTop - $result[0].clientHeight;
            if (distFromBottom <= 100) {
                $result.scrollTop($result[0].scrollHeight);
            }

            if (recData.Event === "MESSAGE") {
                beep();
            }
        }

        // ì¬ì—°ê²° í›„ ë†“ì¹œ ë©”ì‹œì§€ ì¶”ê°€ìš© (owner íŒë³„ í¬í•¨)
        function appendMsg(user, message, isOwner, msgId) {
            var outArea = document.getElementById('result');
            var newTagP = document.createElement('p');
            var newTagSpan = document.createElement('span');

            if (isOwner) {
                newTagP.setAttribute('class', 'p-me preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-me');
            } else {
                newTagP.setAttribute('class', 'p-you preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-you');

                var newTagSpanUser = document.createElement('span');
                newTagSpanUser.setAttribute('class', 'user-name');
                newTagSpanUser.innerText = user || '';
                newTagP.appendChild(newTagSpanUser);

                var newTagSpanSpace = document.createElement('span');
                newTagSpanSpace.setAttribute('class', 'user-name-space');
                newTagSpanSpace.innerText = ' ';
                newTagP.appendChild(newTagSpanSpace);
            }

            var msgTextSpan = document.createElement('span');
            msgTextSpan.setAttribute('class', 'msg-text');
            if (message && validURL(message)) {
                if (!validProtocol(message)) {
                    msgTextSpan.innerHTML = '<a class="hypertext" href="https://' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                } else {
                    msgTextSpan.innerHTML = '<a class="hypertext" href="' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                }
            } else {
                msgTextSpan.textContent = message || '';
            }
            newTagSpan.appendChild(msgTextSpan);
            newTagP.appendChild(newTagSpan);

            if (msgId) {
                newTagP.setAttribute('data-msg-id', msgId);
                var actionsDiv = document.createElement('div');
                actionsDiv.setAttribute('class', 'msg-actions');
                actionsDiv.innerHTML = '<button class="msg-reply-btn">ë‹µì¥</button>';
                if (isOwner) {
                    actionsDiv.innerHTML += '<button class="msg-edit-btn">ìˆ˜ì •</button>' +
                                           '<button class="msg-delete-btn">ì‚­ì œ</button>';
                }
                newTagP.appendChild(actionsDiv);
            }

            outArea.appendChild(newTagP);
            trimOldMessages();

            // #123: ì‚¬ìš©ìê°€ í•˜ë‹¨ 100px ì´ë‚´ì— ìˆì„ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤
            var $result = $('#result');
            var distFromBottom = $result[0].scrollHeight - $result[0].scrollTop - $result[0].clientHeight;
            if (distFromBottom <= 100) {
                $result.scrollTop($result[0].scrollHeight);
            }
        }

        // ì´ì „ ë©”ì‹œì§€ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€ (ë¬´í•œ ìŠ¤í¬ë¡¤)
        function prependChatMessage(chatMsg) {
            var outArea = document.getElementById('result');
            var newTagP = document.createElement('p');
            var newTagSpan = document.createElement('span');
            var user = chatMsg.user || '';
            var message = chatMsg.message || '';
            var isOwner = user === currentUser;

            if (isOwner) {
                newTagP.setAttribute('class', 'p-me preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-me');
            } else {
                newTagP.setAttribute('class', 'p-you preserve-whitespace');
                newTagSpan.setAttribute('class', 'span-you');

                var newTagSpanUser = document.createElement('span');
                newTagSpanUser.setAttribute('class', 'user-name');
                newTagSpanUser.innerText = user;
                newTagP.appendChild(newTagSpanUser);

                var newTagSpanSpace = document.createElement('span');
                newTagSpanSpace.setAttribute('class', 'user-name-space');
                newTagSpanSpace.innerText = ' ';
                newTagP.appendChild(newTagSpanSpace);
            }

            if (message && validURL(message)) {
                if (!validProtocol(message)) {
                    newTagSpan.innerHTML = '<a class="hypertext" href="https://' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                } else {
                    newTagSpan.innerHTML = '<a class="hypertext" href="' + escapeHtml(message) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(message) + '</a>';
                }
            } else {
                newTagSpan.textContent = message;
            }

            newTagP.appendChild(newTagSpan);
            outArea.insertBefore(newTagP, outArea.firstChild);
            trimNewMessages();
        }

        // ì´ì „ ë©”ì‹œì§€ ë¡œë”© (ë¬´í•œ ìŠ¤í¬ë¡¤)
        function loadOlderMessages() {
            if (!oldestTimestamp || loading || !hasMore) return;
            loading = true;
            $('#result').prepend('<div id="load-spinner" class="text-center py-2"><small class="text-muted">ì´ì „ ë©”ì‹œì§€ ë¡œë”© ì¤‘...</small></div>');

            var scrollHeight = $('#result')[0].scrollHeight;

            $.ajax({
                url: '/rooms/' + currentRoomID + '/messages?before=' + encodeURIComponent(oldestTimestamp) + '&limit=50',
                success: function(data) {
                    $('#load-spinner').remove();
                    var messages = data.messages || [];
                    hasMore = data.has_more;

                    if (messages.length === 0) {
                        hasMore = false;
                        $('#result').prepend('<div class="text-center py-2"><small class="text-muted">ëŒ€í™”ì˜ ì‹œì‘ì…ë‹ˆë‹¤</small></div>');
                        loading = false;
                        return;
                    }

                    oldestTimestamp = messages[0].created_at;

                    // ì—­ìˆœìœ¼ë¡œ prepend (messagesëŠ” ì˜¤ë˜ëœ ê²ƒë¶€í„° ì •ë ¬)
                    for (var i = messages.length - 1; i >= 0; i--) {
                        var msg = messages[i];
                        prependChatMessage(msg);
                    }

                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì¡´
                    var newScrollHeight = $('#result')[0].scrollHeight;
                    $('#result')[0].scrollTop = newScrollHeight - scrollHeight;

                    loading = false;
                },
                error: function() {
                    $('#load-spinner').remove();
                    loading = false;
                }
            });
        }

        // ë¬´í•œ ìŠ¤í¬ë¡¤: #result ìµœìƒë‹¨ ë„ë‹¬ ì‹œ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
        $('#result').on('scroll', function() {
            if (this.scrollTop === 0 && !loading && hasMore) {
                loadOlderMessages();
            }
        });

        // ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ
        function loadMembers(roomId) {
            $.ajax({
                url: '/rooms/' + roomId,
                method: 'GET',
                success: function (room) {
                    var online = room.online_members || [];
                    var members = room.members || [];
                    $('#member-count').text(online.length + 'ëª…');

                    var $list = $('#members-list');
                    $list.empty();
                    // ì˜¨ë¼ì¸ ë©¤ë²„ ë¨¼ì €
                    online.forEach(function (name) {
                        $list.append('<div class="member-item online">' + escapeHtml(name) + ' <span class="badge bg-success">ì ‘ì†ì¤‘</span></div>');
                    });
                    // ì˜¤í”„ë¼ì¸ ë©¤ë²„
                    members.forEach(function (name) {
                        if (online.indexOf(name) === -1) {
                            $list.append('<div class="member-item">' + escapeHtml(name) + '</div>');
                        }
                    });
                }
            });
        }

        // ë©”ì‹œì§€ ì „ì†¡
        $("#chat-message").on("keyup", function (e) {
            if (e.keyCode == 13) {
                $("#submit-btn").click();
            }
        });

        $("#submit-btn").on("click", function () {
            var msg = $("#chat-message").val();
            if (msg == null || msg == "" || msg.trim() == "") return false;
            var sendData = { event: "MESSAGE", user: "", message: msg };
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(sendData));
            }
            // ì „ì†¡ í›„ íƒ€ì´í•‘ ìƒíƒœ ì´ˆê¸°í™”
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: "TYPING_STOP" }));
                }
            }
            $("#chat-message").val("");
        });

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì „ì†¡
        $("#chat-message").on("input", function () {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!isTyping) {
                isTyping = true;
                ws.send(JSON.stringify({ event: "TYPING_START" }));
            }
            clearTimeout(typingTimer);
            typingTimer = setTimeout(function () {
                isTyping = false;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: "TYPING_STOP" }));
                }
            }, 3000);
        });

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateTypingIndicator() {
            var users = Object.keys(typingUsers);
            var $indicator = $('#typing-indicator');
            if (users.length === 0) {
                $indicator.text('');
            } else if (users.length === 1) {
                $indicator.text(escapeHtml(users[0]) + 'ë‹˜ì´ ì…ë ¥ ì¤‘...');
            } else {
                $indicator.text(escapeHtml(users.join(', ')) + 'ë‹˜ì´ ì…ë ¥ ì¤‘...');
            }
        }

        // ì±„íŒ…ë°© ìƒì„±
        $('#new-room-public').on('change', function () {
            if ($(this).is(':checked')) {
                $('#password-field').hide();
            } else {
                $('#password-field').show();
            }
        });

        $('#confirm-create-room').on('click', function () {
            var name = $('#new-room-name').val().trim();
            if (!name) {
                alert('ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            var data = {
                name: name,
                description: $('#new-room-desc').val().trim(),
                is_public: $('#new-room-public').is(':checked'),
                password: $('#new-room-password').val(),
                max_members: parseInt($('#new-room-max').val()) || 0
            };
            $.ajax({
                url: '/rooms',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (room) {
                    bootstrap.Modal.getInstance(document.getElementById('createRoomModal')).hide();
                    $('#new-room-name').val('');
                    $('#new-room-desc').val('');
                    $('#new-room-password').val('');
                    $('#new-room-max').val('0');
                    $('#new-room-public').prop('checked', true);
                    $('#password-field').hide();
                    loadRooms();
                    switchRoom(room.id, room.name, room.description);
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : 'ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // ë¹„ë°€ë²ˆí˜¸ ì°¸ì—¬
        $('#confirm-join-password').on('click', function () {
            if (!pendingJoinRoomID) return;
            var pw = $('#join-room-password').val();
            $.ajax({
                url: '/rooms/' + pendingJoinRoomID + '/join',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ password: pw }),
                success: function () {
                    bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
                    $('#join-room-password').val('');
                    // Find room info and switch
                    $.ajax({
                        url: '/rooms/' + pendingJoinRoomID,
                        method: 'GET',
                        success: function (room) {
                            switchRoom(room.id, room.name, room.description);
                        }
                    });
                    pendingJoinRoomID = null;
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : 'ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // ì°¸ì—¬ì íŒ¨ë„ í† ê¸€
        $('#toggle-members').on('click', function () {
            $('#members-panel').toggleClass('d-none');
            if (!$('#members-panel').hasClass('d-none') && currentRoomID) {
                loadMembers(currentRoomID);
            }
        });

        // DOM ê°€ìƒí™”: ìƒˆ ë©”ì‹œì§€ ì¶”ê°€ í›„ ìœ„ìª½(ì˜¤ë˜ëœ) ë…¸ë“œ ì œê±°
        function trimOldMessages() {
            var outArea = document.getElementById('result');
            var children = outArea.children;
            while (children.length > MAX_DOM_MESSAGES) {
                outArea.removeChild(children[0]);
            }
        }

        // DOM ê°€ìƒí™”: ì´ì „ ë©”ì‹œì§€ prepend í›„ ì•„ë˜ìª½(ìƒˆ) ë…¸ë“œ ì œê±°
        function trimNewMessages() {
            var outArea = document.getElementById('result');
            var children = outArea.children;
            while (children.length > MAX_DOM_MESSAGES) {
                outArea.removeChild(children[children.length - 1]);
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // #119: ì „ì—­ Audio ê°ì²´ ì¬ì‚¬ìš© (Audio leak ë°©ì§€)
        var _beepAudio = new Audio("/view/sound/alert.mp3");
        function beep() {
            _beepAudio.currentTime = 0;
            _beepAudio.play();
        }

        function validURL(str) {
            var pattern = new RegExp('^(https?:\\/\\/)?' +
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' +
                '((\\d{1,3}\\.){3}\\d{1,3}))' +
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' +
                '(\\?[;&a-z\\d%_.~+=-]*)?' +
                '(\\#[-a-z\\d_]*)?$', 'i');
            return !!pattern.test(str);
        }

        function validProtocol(str) {
            // Only allow http and https; block javascript:, data:, etc.
            var pattern = /^https?:\/\//i;
            return !!pattern.test(str);
        }

        function safeHref(url) {
            // Double-check: only return URL if http/https
            if (/^https?:\/\//i.test(url)) return url;
            return 'https://' + url;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // WebSocket ì—°ê²° ëŠê¹€ UI ì•Œë¦¼
        function showToast(msg, type) {
            var toast = $('<div class="ws-toast ws-toast-' + (type || 'info') + '">' + escapeHtml(msg) + '</div>');
            $('body').append(toast);
            setTimeout(function () { toast.fadeOut(500, function () { toast.remove(); }); }, 5000);
        }

        // â”€â”€ í”„ë¡œí•„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function loadProfile() {
            $.ajax({
                url: '/auth/me',
                method: 'GET',
                success: function (user) {
                    var name = user.display_name || user.username || currentUser;
                    var bio  = user.bio || '';
                    $('#profile-display-name-show').text(name);
                    $('#profile-bio-show').text(bio);
                    $('#profile-display-name').val(name);
                    $('#profile-bio').val(bio);
                }
            });
        }

        $('#confirm-profile-save').on('click', function () {
            var displayName = $('#profile-display-name').val().trim();
            var bio         = $('#profile-bio').val().trim();
            $.ajax({
                url: '/users/me/profile',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ display_name: displayName, bio: bio }),
                success: function (user) {
                    var name = user.display_name || user.username || currentUser;
                    $('#profile-display-name-show').text(name);
                    $('#profile-bio-show').text(user.bio || '');
                    bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : 'í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // â”€â”€ ë‹µì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var replyToMsgID = null;

        function setReplyTo(msgId, msgText) {
            replyToMsgID = msgId;
            $('#reply-preview-text').text('ë‹µì¥: ' + msgText);
            $('#reply-preview').addClass('active');
            $('#chat-message').focus();
        }

        function clearReplyTo() {
            replyToMsgID = null;
            $('#reply-preview').removeClass('active');
            $('#reply-preview-text').text('');
        }

        $('#reply-cancel').on('click', function () {
            clearReplyTo();
        });

        // â”€â”€ ë©”ì‹œì§€ ì „ì†¡ ì‹œ reply_to í¬í•¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Override submit to handle reply via REST when replyToMsgID is set
        $('#submit-btn').off('click').on('click', function () {
            var msg = $('#chat-message').val();
            if (!msg || msg.trim() === '') return false;

            if (replyToMsgID) {
                // Send reply via REST
                $.ajax({
                    url: '/rooms/' + currentRoomID + '/messages/' + replyToMsgID + '/reply',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: msg }),
                    success: function () {
                        clearReplyTo();
                    },
                    error: function (xhr) {
                        var resp = xhr.responseJSON;
                        alert(resp ? resp.error : 'ë‹µì¥ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            } else {
                // Normal message via WebSocket
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: 'MESSAGE', user: '', message: msg }));
                }
            }

            // Stop typing indicator
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: 'TYPING_STOP' }));
                }
            }
            $('#chat-message').val('');
        });

        // í•œê¸€ IME ì´ì¤‘ì „ì†¡ ë°©ì§€
        var isComposing = false;
        document.getElementById('chat-message').addEventListener('compositionstart', function () {
            isComposing = true;
        });
        document.getElementById('chat-message').addEventListener('compositionend', function () {
            isComposing = false;
        });

        // Enter key for the overridden submit
        $('#chat-message').off('keyup').on('keyup', function (e) {
            if (e.keyCode === 13 && !isComposing) {
                $('#submit-btn').click();
            }
        });

        // â”€â”€ ë©”ì‹œì§€ í¸ì§‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var editingMsgID = null;

        $(document).on('click', '.msg-edit-btn', function () {
            var $p = $(this).closest('p');
            editingMsgID = $p.data('msg-id');
            var currentText = $p.find('.msg-text').text();
            $('#edit-message-input').val(currentText);
            var modal = new bootstrap.Modal(document.getElementById('editMessageModal'));
            modal.show();
        });

        $('#confirm-edit-message').on('click', function () {
            if (!editingMsgID) return;
            var newMsg = $('#edit-message-input').val().trim();
            if (!newMsg) return;
            $.ajax({
                url: '/rooms/' + currentRoomID + '/messages/' + editingMsgID,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ message: newMsg }),
                success: function () {
                    bootstrap.Modal.getInstance(document.getElementById('editMessageModal')).hide();
                    editingMsgID = null;
                },
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // â”€â”€ ë©”ì‹œì§€ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $(document).on('click', '.msg-delete-btn', function () {
            if (!confirm('ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            var $p = $(this).closest('p');
            var msgId = $p.data('msg-id');
            $.ajax({
                url: '/rooms/' + currentRoomID + '/messages/' + msgId,
                method: 'DELETE',
                success: function () {},
                error: function (xhr) {
                    var resp = xhr.responseJSON;
                    alert(resp ? resp.error : 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // â”€â”€ ë‹µì¥ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $(document).on('click', '.msg-reply-btn', function () {
            var $p = $(this).closest('p');
            var msgId = $p.data('msg-id');
            var msgText = $p.find('.msg-text').text().substring(0, 50);
            setReplyTo(msgId, msgText);
        });

        // â”€â”€ WS MSG_EDIT / MSG_DELETE ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Patch appendMessage to also handle MSG_EDIT and MSG_DELETE
        var _origAppendMessage = appendMessage;
        appendMessage = function (recData) {
            if (recData.Event === 'MSG_EDIT') {
                var $p = $('p[data-msg-id="' + recData.message_id + '"]');
                if ($p.length) {
                    $p.find('.msg-text').text(recData.message);
                }
                return;
            }
            if (recData.Event === 'MSG_DELETE') {
                var $p = $('p[data-msg-id="' + recData.message_id + '"]');
                if ($p.length) {
                    $p.find('.msg-text').text('(ì‚­ì œëœ ë©”ì‹œì§€)').css('color', '#aaa');
                    $p.find('.msg-actions').remove();
                }
                return;
            }
            _origAppendMessage(recData);
        };

        // í”„ë¡œí•„ ì´ˆê¸° ë¡œë“œ
        loadProfile();

        // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
        function checkMobile() {
            if (window.innerWidth < 768) {
                $('#sidebar-toggle').show();
            } else {
                $('#sidebar-toggle').hide();
                $('#sidebar').removeClass('sidebar-open');
                $('#sidebar-backdrop').removeClass('active');
            }
        }

        function closeSidebar() {
            $('#sidebar').removeClass('sidebar-open');
            $('#sidebar-backdrop').removeClass('active');
        }

        $('#sidebar-toggle').on('click', function () {
            $('#sidebar').toggleClass('sidebar-open');
            $('#sidebar-backdrop').toggleClass('active');
        });

        $('#sidebar-backdrop').on('click', function () {
            closeSidebar();
        });

        // ë°© ì„ íƒ ì‹œ ì‚¬ì´ë“œë°” ë‹«ê¸° (ëª¨ë°”ì¼)
        $(document).on('click', '.room-item', function () {
            if (window.innerWidth < 768) {
                closeSidebar();
            }
        });

        $(window).on('resize', function () {
            checkMobile();
        });

        // #122: ëª¨ë°”ì¼ í‚¤ë³´ë“œ í‘œì‹œ ì‹œ ì…ë ¥ ì˜ì—­ ê°€ë ¤ì§ ë°©ì§€ (visualViewport API)
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', function () {
                var app = document.getElementById('app');
                if (app) {
                    app.style.height = window.visualViewport.height + 'px';
                }
            });
        }

        // í„°ì¹˜ ìŠ¤ì™€ì´í”„ë¡œ ì‚¬ì´ë“œë°” ì—´ê¸°/ë‹«ê¸°
        (function () {
            var touchStartX = 0;
            var touchStartY = 0;

            document.addEventListener('touchstart', function (e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', function (e) {
                if (window.innerWidth >= 768) return;
                var dx = e.changedTouches[0].clientX - touchStartX;
                var dy = e.changedTouches[0].clientY - touchStartY;

                // ìˆ˜í‰ ìŠ¤ì™€ì´í”„ê°€ ìˆ˜ì§ë³´ë‹¤ í´ ë•Œë§Œ ì²˜ë¦¬
                if (Math.abs(dx) < Math.abs(dy)) return;

                if (dx > 60 && touchStartX < 40) {
                    // ì™¼ìª½ ê°€ì¥ìë¦¬ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„: ì‚¬ì´ë“œë°” ì—´ê¸°
                    $('#sidebar').addClass('sidebar-open');
                    $('#sidebar-backdrop').addClass('active');
                } else if (dx < -60 && $('#sidebar').hasClass('sidebar-open')) {
                    // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„: ì‚¬ì´ë“œë°” ë‹«ê¸°
                    closeSidebar();
                }
            }, { passive: true });
        })();

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ WebSocket ì •ìƒ ì¢…ë£Œ (code 1000)
        window.addEventListener('beforeunload', function () {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close(1000, 'page unload');
            }
        });

        // ì´ˆê¸° ëª¨ë°”ì¼ ì²´í¬
        checkMobile();

        // â”€â”€ ëª¨ë°”ì¼ í„°ì¹˜: ë¡±í”„ë ˆìŠ¤ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function () {
            var longPressTimer = null;
            var LONG_PRESS_MS = 500;
            var $ctxMenu = null;

            function showContextMenu(x, y, $p) {
                removeContextMenu();
                var msgId = $p.data('msg-id');
                if (!msgId) return;

                var isOwner = $p.hasClass('p-me');
                var msgText = $p.find('.msg-text').text().substring(0, 50);

                var items = '<div class="ctx-item ctx-reply">ë‹µì¥</div>';
                if (isOwner) {
                    items += '<div class="ctx-item ctx-edit">ìˆ˜ì •</div>';
                    items += '<div class="ctx-item ctx-delete">ì‚­ì œ</div>';
                }

                $ctxMenu = $('<div id="ctx-menu">' + items + '</div>');
                $ctxMenu.css({ top: y, left: x });
                $('body').append($ctxMenu);

                $ctxMenu.find('.ctx-reply').on('click', function () {
                    setReplyTo(msgId, msgText);
                    removeContextMenu();
                });
                $ctxMenu.find('.ctx-edit').on('click', function () {
                    var currentText = $p.find('.msg-text').text();
                    editingMsgID = msgId;
                    $('#edit-message-input').val(currentText);
                    new bootstrap.Modal(document.getElementById('editMessageModal')).show();
                    removeContextMenu();
                });
                $ctxMenu.find('.ctx-delete').on('click', function () {
                    removeContextMenu();
                    if (!confirm('ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                    $.ajax({
                        url: '/rooms/' + currentRoomID + '/messages/' + msgId,
                        method: 'DELETE'
                    });
                });
            }

            function removeContextMenu() {
                if ($ctxMenu) { $ctxMenu.remove(); $ctxMenu = null; }
            }

            $(document).on('touchstart', 'p[data-msg-id]', function (e) {
                var $p = $(this);
                var touch = e.originalEvent.touches[0];
                longPressTimer = setTimeout(function () {
                    e.preventDefault();
                    showContextMenu(touch.clientX, touch.clientY, $p);
                }, LONG_PRESS_MS);
            });

            $(document).on('touchend touchmove touchcancel', 'p[data-msg-id]', function () {
                clearTimeout(longPressTimer);
            });

            $(document).on('click touchstart', function (e) {
                if ($ctxMenu && !$(e.target).closest('#ctx-menu').length) {
                    removeContextMenu();
                }
            });
        })();

        // â”€â”€ ë¸Œë¼ìš°ì € ì•Œë¦¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function () {
            var notifEnabled = localStorage.getItem('notif') !== 'off';

            function updateNotifBtn() {
                $('#notif-toggle').html(notifEnabled ? '&#128276;' : '&#128277;');
                $('#notif-toggle').attr('title', notifEnabled ? 'ì•Œë¦¼ ë„ê¸°' : 'ì•Œë¦¼ ì¼œê¸°');
            }

            // ì•Œë¦¼ ë²„íŠ¼ì„ í—¤ë”ì— ì£¼ì…
            if ('Notification' in window) {
                var $btn = $('<button id="notif-toggle" style="background:none;border:1px solid var(--color-border);color:var(--color-sidebar-text);border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;padding:0;" aria-label="ì•Œë¦¼ ì„¤ì •"></button>');
                $('#theme-toggle').after($btn);
                updateNotifBtn();

                $('#notif-toggle').on('click', function () {
                    if (!notifEnabled) {
                        Notification.requestPermission().then(function (perm) {
                            if (perm === 'granted') {
                                notifEnabled = true;
                                localStorage.setItem('notif', 'on');
                                updateNotifBtn();
                            }
                        });
                    } else {
                        notifEnabled = false;
                        localStorage.setItem('notif', 'off');
                        updateNotifBtn();
                    }
                });

                // ìµœì´ˆ ë°©ë¬¸ ì‹œ ê¶Œí•œ ìš”ì²­
                if (notifEnabled && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì•Œë¦¼ í‘œì‹œ
            var _origBeep = beep;
            beep = function () {
                _origBeep();
                if (notifEnabled &&
                    'Notification' in window &&
                    Notification.permission === 'granted' &&
                    document.hidden) {
                    new Notification('Woongkie-Talkie', {
                        body: 'ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.',
                        icon: '/view/favicon/favicon-32x32.png'
                    });
                }
            };
        })();

        // â”€â”€ ë‹¤í¬ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function () {
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                $('#theme-toggle').html(theme === 'dark' ? '&#9728;' : '&#9790;');
                localStorage.setItem('theme', theme);
            }

            var saved = localStorage.getItem('theme');
            if (saved) {
                applyTheme(saved);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }

            $('#theme-toggle').on('click', function () {
                var current = document.documentElement.getAttribute('data-theme');
                applyTheme(current === 'dark' ? 'light' : 'dark');
            });

            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
                    if (!localStorage.getItem('theme')) {
                        applyTheme(e.matches ? 'dark' : 'light');
                    }
                });
            }
        })();

        // â”€â”€ #69: ì˜¤í”„ë¼ì¸ ë©”ì‹œì§€ í â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var offlineQueue = [];

        function flushOfflineQueue() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            var queue = offlineQueue.slice();
            offlineQueue = [];
            try { localStorage.removeItem('offlineQueue'); } catch(e) {}
            queue.forEach(function (item) {
                ws.send(JSON.stringify(item));
            });
        }

        // connectWebSocket ì‹¤í–‰ í›„ ws.onopenì„ ë˜í•‘í•˜ì—¬ í í”ŒëŸ¬ì‹œ ì¶”ê°€
        var _origConnectWS = connectWebSocket;
        connectWebSocket = function (roomId) {
            _origConnectWS(roomId);
            var _prevOnOpen = ws.onopen;
            ws.onopen = function (evt) {
                if (_prevOnOpen) _prevOnOpen.call(ws, evt);
                flushOfflineQueue();
            };
        };

        // â”€â”€ #86: ë©”ì‹œì§€ ê²€ìƒ‰ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function () {
            var searchDebounceTimer = null;
            var isSearchActive = false;

            $('#search-input').on('input', function () {
                var query = $(this).val().trim();
                clearTimeout(searchDebounceTimer);
                if (query.length === 0) {
                    clearSearch();
                    return;
                }
                $('#search-clear-btn').show();
                searchDebounceTimer = setTimeout(function () {
                    doSearch(query);
                }, 300);
            });

            $('#search-clear-btn').on('click', function () {
                $('#search-input').val('');
                clearSearch();
            });

            function clearSearch() {
                $('#search-clear-btn').hide();
                $('#search-results-container').hide().empty();
                $('#chat-body').show();
                isSearchActive = false;
            }

            function doSearch(query) {
                if (!currentRoomID) return;
                authFetch('/rooms/' + currentRoomID + '/messages/search?q=' + encodeURIComponent(query))
                    .then(function (resp) {
                        if (!resp) return;
                        return resp.json();
                    })
                    .then(function (data) {
                        if (!data) return;
                        var messages = data.messages || data || [];
                        renderSearchResults(messages, query);
                    })
                    .catch(function () {
                        renderSearchResults([], query);
                    });
            }

            function renderSearchResults(messages, query) {
                var $container = $('#search-results-container');
                $container.empty();
                $('#chat-body').hide();
                $container.show();
                isSearchActive = true;

                if (messages.length === 0) {
                    $container.html('<div class="search-no-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                    return;
                }

                messages.forEach(function (msg) {
                    var text = msg.message || '';
                    var user = msg.user || '';
                    var highlighted = highlightQuery(escapeHtml(text), escapeHtml(query));
                    var $item = $('<div class="search-result-item"></div>');
                    $item.html('<strong>' + escapeHtml(user) + '</strong>: ' + highlighted);
                    $container.append($item);
                });
            }

            function highlightQuery(safeText, safeQuery) {
                if (!safeQuery) return safeText;
                var re = new RegExp('(' + safeQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                return safeText.replace(re, '<mark class="search-highlight">$1</mark>');
            }
        })();

        // â”€â”€ #88: ì´ëª¨ì§€ í”¼ì»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function () {
            var $picker = $('#emoji-picker');
            var $btn = $('#emoji-btn');
            var $input = $('#chat-message');

            $btn.on('click', function (e) {
                e.stopPropagation();
                $picker.toggleClass('open');
            });

            // ì´ëª¨ì§€ í´ë¦­: ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
            $picker.on('click', '.emoji-grid button', function (e) {
                e.stopPropagation();
                var emoji = $(this).text();
                var inputEl = $input[0];
                var start = inputEl.selectionStart;
                var end = inputEl.selectionEnd;
                var val = $input.val();
                var newVal = val.substring(0, start) + emoji + val.substring(end);
                $input.val(newVal);
                // ì»¤ì„œë¥¼ ì´ëª¨ì§€ ë’¤ë¡œ
                var newPos = start + emoji.length;
                inputEl.setSelectionRange(newPos, newPos);
                $input.focus();
                $picker.removeClass('open');
            });

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#emoji-btn, #emoji-picker').length) {
                    $picker.removeClass('open');
                }
            });

            // ESC í‚¤ë¡œ ë‹«ê¸°
            $(document).on('keydown', function (e) {
                if (e.key === 'Escape') {
                    $picker.removeClass('open');
                }
            });
        })();

        // â”€â”€ #69: submit ë²„íŠ¼ ì˜¤í”„ë¼ì¸ í ì²˜ë¦¬ (ê¸°ì¡´ í•¸ë“¤ëŸ¬ ë˜í•‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ê¸°ì¡´ #submit-btn click í•¸ë“¤ëŸ¬ë¥¼ ì˜¤í”„ë¼ì¸ í ì§€ì›ìœ¼ë¡œ í™•ì¥
        $('#submit-btn').off('click').on('click', function () {
            var msg = $('#chat-message').val();
            if (!msg || msg.trim() === '') return false;

            if (replyToMsgID) {
                // ë‹µì¥: REST ì‚¬ìš© (ì˜¤í”„ë¼ì¸ í ë¯¸ì ìš©)
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    showToast('ì—°ê²°ì´ ëŠì–´ì ¸ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'error');
                    return false;
                }
                $.ajax({
                    url: '/rooms/' + currentRoomID + '/messages/' + replyToMsgID + '/reply',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: msg }),
                    success: function () { clearReplyTo(); },
                    error: function (xhr) {
                        var resp = xhr.responseJSON;
                        alert(resp ? resp.error : 'ë‹µì¥ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            } else if (ws && ws.readyState === WebSocket.OPEN) {
                // ì •ìƒ ì „ì†¡
                ws.send(JSON.stringify({ event: 'MESSAGE', user: '', message: msg }));
            } else {
                // ì˜¤í”„ë¼ì¸: íì— ì¶”ê°€í•˜ê³  UIì— ëŒ€ê¸° í‘œì‹œ
                var queueItem = { event: 'MESSAGE', user: '', message: msg };
                offlineQueue.push(queueItem);
                try { localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue)); } catch(e) {}

                // ëŒ€ê¸° ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œ
                var $pending = $('<p class="p-me preserve-whitespace msg-pending"></p>');
                $pending.append('<span class="span-me"><span class="msg-text">' + escapeHtml(msg) + '</span><span class="msg-pending-label">(ì „ì†¡ ëŒ€ê¸°ì¤‘)</span></span>');
                $('#result').append($pending);
                var $r = $('#result');
                $r.scrollTop($r[0].scrollHeight);
                showToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ë©”ì‹œì§€ê°€ ì—°ê²° í›„ ì „ì†¡ë©ë‹ˆë‹¤.', 'warning');
            }

            // íƒ€ì´í•‘ ìƒíƒœ ì´ˆê¸°í™”
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ event: 'TYPING_STOP' }));
                }
            }
            $('#chat-message').val('');
        });

        // #131: ëª¨ë°”ì¼ í™”ë©´ íšŒì „ ì‹œ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°
        (function () {
            function adjustLayout() {
                var $result = $('#result');
                var $body = $('#chat-body');
                var headerH = $('#chat-header').outerHeight(true) || 0;
                var postH = $('#post-message').outerHeight(true) || 0;
                var typingH = $('#typing-indicator').outerHeight(true) || 0;
                var replyH = $('#reply-preview').outerHeight(true) || 0;
                var available = window.innerHeight - headerH - postH - typingH - replyH;
                if (available > 0) {
                    $body.css('height', available + 'px');
                }
            }

            window.addEventListener('orientationchange', function () {
                setTimeout(adjustLayout, 100);
            });

            window.addEventListener('resize', function () {
                if (window.innerHeight < 500) {
                    adjustLayout();
                }
            });
        })();
    </script>
</body>

</html>
